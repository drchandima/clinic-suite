{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/Education/WebDev%20with%20AI/Projects/clinic-suite/components/PharmacySidebar.js"],"sourcesContent":["// components/PharmacySidebar.js\r\n'use client';\r\n\r\nimport React from 'react';\r\n\r\n/**\r\n * PharmacySidebar\r\n * Props:\r\n *  - prescriptions: array of prescription objects\r\n *  - onSelect(prescription)\r\n *  - selectedId: id of selected prescription\r\n *  - selectedPrescription: the currently selected prescription (object) to preview below\r\n */\r\nexport default function PharmacySidebar({ prescriptions = [], onSelect = () => {}, selectedId = null, selectedPrescription = null }) {\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"rounded-xl bg-white p-4 shadow-sm\">\r\n        <div className=\"text-sm font-medium text-slate-800\">Prescriptions</div>\r\n        <div className=\"text-xs text-slate-500 mt-1\">Pending prescriptions from doctors</div>\r\n\r\n        <div className=\"mt-3 space-y-2 max-h-[48vh] overflow-auto\">\r\n          {prescriptions.length === 0 && <div className=\"text-sm text-slate-400\">No pending prescriptions</div>}\r\n\r\n          {prescriptions.map((p) => (\r\n            <button\r\n              key={p.id}\r\n              onClick={() => onSelect(p)}\r\n              className={`w-full text-left p-3 border rounded transition-colors duration-100 ${selectedId === p.id ? 'bg-indigo-50 ring-1 ring-indigo-200' : 'hover:bg-slate-50'}`}\r\n            >\r\n              <div className=\"flex justify-between\">\r\n                <div className=\"text-sm font-medium\">{p.patientNic ?? 'Unknown'}</div>\r\n                <div className=\"text-xs text-slate-500\">{p.createdAt ? new Date(p.createdAt).toLocaleString() : ''}</div>\r\n              </div>\r\n              <div className=\"text-xs text-slate-400 mt-1\">Doctor: {p.doctorEmail ?? '-'}</div>\r\n            </button>\r\n          ))}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Selected prescription preview */}\r\n      <div className=\"rounded-xl bg-white p-4 shadow-sm\">\r\n        <div className=\"text-sm font-medium text-slate-800\">Selected prescription</div>\r\n        <div className=\"text-xs text-slate-500 mt-1\">Doctor's raw management</div>\r\n        <div className=\"mt-3\">\r\n          {selectedPrescription ? (\r\n            <div>\r\n              <div className=\"text-sm\"><strong>Patient:</strong> {selectedPrescription.patientNic}</div>\r\n              <div className=\"text-sm\"><strong>Doctor:</strong> {selectedPrescription.doctorEmail}</div>\r\n              <div className=\"mt-2 whitespace-pre-wrap text-sm text-slate-700\">{selectedPrescription.rawManagement || '- (no management text) -'}</div>\r\n            </div>\r\n          ) : <div className=\"text-sm text-slate-400\">Select a prescription</div>}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"AAAA,gCAAgC;;;;;;AAGhC;AAFA;;;AAYe,SAAS,gBAAgB,EAAE,gBAAgB,EAAE,EAAE,WAAW,KAAO,CAAC,EAAE,aAAa,IAAI,EAAE,uBAAuB,IAAI,EAAE;IACjI,qBACE,gNAAC;QAAI,WAAU;;0BACb,gNAAC;gBAAI,WAAU;;kCACb,gNAAC;wBAAI,WAAU;kCAAqC;;;;;;kCACpD,gNAAC;wBAAI,WAAU;kCAA8B;;;;;;kCAE7C,gNAAC;wBAAI,WAAU;;4BACZ,cAAc,MAAM,KAAK,mBAAK,gNAAC;gCAAI,WAAU;0CAAyB;;;;;;4BAEtE,cAAc,GAAG,CAAC,CAAC,kBAClB,gNAAC;oCAEC,SAAS,IAAM,SAAS;oCACxB,WAAW,CAAC,mEAAmE,EAAE,eAAe,EAAE,EAAE,GAAG,wCAAwC,qBAAqB;;sDAEpK,gNAAC;4CAAI,WAAU;;8DACb,gNAAC;oDAAI,WAAU;8DAAuB,EAAE,UAAU,IAAI;;;;;;8DACtD,gNAAC;oDAAI,WAAU;8DAA0B,EAAE,SAAS,GAAG,IAAI,KAAK,EAAE,SAAS,EAAE,cAAc,KAAK;;;;;;;;;;;;sDAElG,gNAAC;4CAAI,WAAU;;gDAA8B;gDAAS,EAAE,WAAW,IAAI;;;;;;;;mCARlE,EAAE,EAAE;;;;;;;;;;;;;;;;;0BAejB,gNAAC;gBAAI,WAAU;;kCACb,gNAAC;wBAAI,WAAU;kCAAqC;;;;;;kCACpD,gNAAC;wBAAI,WAAU;kCAA8B;;;;;;kCAC7C,gNAAC;wBAAI,WAAU;kCACZ,qCACC,gNAAC;;8CACC,gNAAC;oCAAI,WAAU;;sDAAU,gNAAC;sDAAO;;;;;;wCAAiB;wCAAE,qBAAqB,UAAU;;;;;;;8CACnF,gNAAC;oCAAI,WAAU;;sDAAU,gNAAC;sDAAO;;;;;;wCAAgB;wCAAE,qBAAqB,WAAW;;;;;;;8CACnF,gNAAC;oCAAI,WAAU;8CAAmD,qBAAqB,aAAa,IAAI;;;;;;;;;;;iDAExG,gNAAC;4BAAI,WAAU;sCAAyB;;;;;;;;;;;;;;;;;;;;;;;AAKtD;KA1CwB"}},
    {"offset": {"line": 214, "column": 0}, "map": {"version":3,"sources":["file:///D:/Education/WebDev%20with%20AI/Projects/clinic-suite/utils/idHelpers.js"],"sourcesContent":["// utils/idHelpers.js\nexport function formatDateToId(date = new Date()){\n  const d = (date instanceof Date) ? date : new Date(date);\n  const pad = (n) => String(n).padStart(2, '0');\n  const YYYY = d.getFullYear();\n  const MM = pad(d.getMonth() + 1);\n  const DD = pad(d.getDate());\n  const hh = pad(d.getHours());\n  const mm = pad(d.getMinutes());\n  const ss = pad(d.getSeconds());\n  return `${YYYY}${MM}${DD}${hh}${mm}${ss}`;\n}\n"],"names":[],"mappings":"AAAA,qBAAqB;;;;;AACd,SAAS,eAAe,OAAO,IAAI,MAAM;IAC9C,MAAM,IAAI,AAAC,gBAAgB,OAAQ,OAAO,IAAI,KAAK;IACnD,MAAM,MAAM,CAAC,IAAM,OAAO,GAAG,QAAQ,CAAC,GAAG;IACzC,MAAM,OAAO,EAAE,WAAW;IAC1B,MAAM,KAAK,IAAI,EAAE,QAAQ,KAAK;IAC9B,MAAM,KAAK,IAAI,EAAE,OAAO;IACxB,MAAM,KAAK,IAAI,EAAE,QAAQ;IACzB,MAAM,KAAK,IAAI,EAAE,UAAU;IAC3B,MAAM,KAAK,IAAI,EAAE,UAAU;IAC3B,OAAO,GAAG,OAAO,KAAK,KAAK,KAAK,KAAK,IAAI;AAC3C"}},
    {"offset": {"line": 237, "column": 0}, "map": {"version":3,"sources":["file:///D:/Education/WebDev%20with%20AI/Projects/clinic-suite/lib/firestoreClient.js"],"sourcesContent":["// lib/firestoreClient.js\r\n// Consolidated Firestore client helpers for Clinic Suite\r\nimport { db } from './firebase';\r\nimport {\r\n  collection,\r\n  doc,\r\n  setDoc,\r\n  getDocs,\r\n  query,\r\n  orderBy,\r\n  onSnapshot,\r\n  where,\r\n  updateDoc,\r\n  deleteDoc,\r\n  getDoc,\r\n  addDoc,\r\n  runTransaction\r\n} from 'firebase/firestore';\r\nimport { formatDateToId } from '../utils/idHelpers';\r\n\r\n/* ============================\r\n   Collection reference helpers\r\n   ============================ */\r\nfunction patientsCollectionRef(clinicId) {\r\n  return collection(db, 'clinics', clinicId, 'patients');\r\n}\r\nfunction appointmentsCollectionRef(clinicId) {\r\n  return collection(db, 'clinics', clinicId, 'appointments');\r\n}\r\nfunction drugsCollectionRef(clinicId) {\r\n  return collection(db, 'clinics', clinicId, 'drugs');\r\n}\r\nfunction consultationsCollectionRef(clinicId) {\r\n  return collection(db, 'clinics', clinicId, 'consultations');\r\n}\r\nfunction prescriptionsCollectionRef(clinicId) {\r\n  return collection(db, 'clinics', clinicId, 'prescriptions');\r\n}\r\nfunction invoicesCollectionRef(clinicId) {\r\n  return collection(db, 'clinics', clinicId, 'invoices');\r\n}\r\n\r\n/* ============================\r\n   Patients\r\n   ============================ */\r\n\r\n/* Patients: subscribe live */\r\nexport function subscribePatients(clinicId, callback, onError) {\r\n  if (!clinicId) {\r\n    if (onError) onError(new Error('clinicId required'));\r\n    return () => {};\r\n  }\r\n  const q = query(patientsCollectionRef(clinicId), orderBy('createdAt', 'desc'));\r\n  const unsub = onSnapshot(q, (snap) => {\r\n    const items = snap.docs.map((d) => ({ id: d.id, ...d.data() }));\r\n    callback(items);\r\n  }, onError);\r\n  return unsub;\r\n}\r\n\r\n/* fetch once */\r\nexport async function fetchPatientsOnce(clinicId) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const q = query(patientsCollectionRef(clinicId), orderBy('createdAt', 'desc'));\r\n  const snap = await getDocs(q);\r\n  return snap.docs.map((d) => ({ id: d.id, ...d.data() }));\r\n}\r\n\r\n/* create or update patient (patient.nic used as doc id) */\r\nexport async function createOrUpdatePatient(clinicId, patient, createdByEmail = null) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!patient || !patient.nic) throw new Error('patient.nic (NIC) required');\r\n\r\n  const patientId = String(patient.nic).trim();\r\n  const ref = doc(db, 'clinics', clinicId, 'patients', patientId);\r\n\r\n  const now = new Date();\r\n  const payload = {\r\n    ...patient,\r\n    nic: patientId,\r\n    updatedAt: now.toISOString(),\r\n    createdAt: patient.createdAt ?? now.toISOString(),\r\n    createdBy: patient.createdBy ?? createdByEmail ?? null\r\n  };\r\n  await setDoc(ref, payload, { merge: true });\r\n  return { id: patientId, ...payload };\r\n}\r\n\r\n/* get single patient */\r\nexport async function getPatient(clinicId, patientNic) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const ref = doc(db, 'clinics', clinicId, 'patients', String(patientNic));\r\n  const snap = await getDoc(ref);\r\n  if (!snap.exists()) return null;\r\n  return { id: snap.id, ...snap.data() };\r\n}\r\n\r\n/* update patient fields */\r\nexport async function updatePatient(clinicId, patientNic, data) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const ref = doc(db, 'clinics', clinicId, 'patients', String(patientNic));\r\n  await updateDoc(ref, { ...data, updatedAt: new Date().toISOString() });\r\n  const snap = await getDoc(ref);\r\n  return { id: snap.id, ...snap.data() };\r\n}\r\n\r\n/* ============================\r\n   Appointments\r\n   ============================ */\r\n\r\n/* Appointments: create using scheduledAt -> YYYYMMDDHHMMSS id */\r\nexport async function createAppointment(clinicId, { patientNic, scheduledAtISO, receptionistEmail = null, notes = '', status = 'confirmed' }) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!patientNic) throw new Error('patientNic required');\r\n\r\n  const scheduledDate = (scheduledAtISO instanceof Date) ? scheduledAtISO : new Date(scheduledAtISO);\r\n  if (Number.isNaN(scheduledDate.getTime())) throw new Error('Invalid scheduledAt value');\r\n\r\n  const appointmentId = formatDateToId(scheduledDate);\r\n  const ref = doc(db, 'clinics', clinicId, 'appointments', appointmentId);\r\n\r\n  const payload = {\r\n    patientNic: String(patientNic).trim(),\r\n    scheduledAt: scheduledDate.toISOString(),\r\n    status,\r\n    receptionistEmail,\r\n    notes,\r\n    createdAt: new Date().toISOString()\r\n  };\r\n\r\n  await setDoc(ref, payload, { merge: false });\r\n  return { id: appointmentId, ...payload };\r\n}\r\n\r\n/* fetch appointments for a patient (once) — client-side sort */\r\nexport async function fetchAppointmentsForPatient(clinicId, patientNic) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const coll = appointmentsCollectionRef(clinicId);\r\n  const q = query(coll, where('patientNic', '==', String(patientNic)));\r\n  const snap = await getDocs(q);\r\n  const items = snap.docs.map((d) => ({ id: d.id, ...d.data() }));\r\n  items.sort((a, b) => (b.scheduledAt || '').localeCompare(a.scheduledAt || ''));\r\n  return items;\r\n}\r\n\r\n/* subscribe appointments for a patient (live) — client-side sort */\r\nexport function subscribeAppointmentsForPatient(clinicId, patientNic, callback, onError) {\r\n  if (!clinicId) {\r\n    if (onError) onError(new Error('clinicId required'));\r\n    return () => {};\r\n  }\r\n  const coll = appointmentsCollectionRef(clinicId);\r\n  const q = query(coll, where('patientNic', '==', String(patientNic)));\r\n  const unsub = onSnapshot(q, (snap) => {\r\n    const items = snap.docs.map((d) => ({ id: d.id, ...d.data() }));\r\n    items.sort((a, b) => (b.scheduledAt || '').localeCompare(a.scheduledAt || ''));\r\n    callback(items);\r\n  }, (err) => {\r\n    console.error('subscribeAppointmentsForPatient error', err);\r\n    if (onError) onError(err);\r\n  });\r\n  return unsub;\r\n}\r\n\r\n/* update appointment (partial) */\r\nexport async function updateAppointment(clinicId, appointmentId, data) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const ref = doc(db, 'clinics', clinicId, 'appointments', String(appointmentId));\r\n  await updateDoc(ref, { ...data, updatedAt: new Date().toISOString() });\r\n  const snap = await getDoc(ref);\r\n  return { id: snap.id, ...snap.data() };\r\n}\r\n\r\n/* cancel appointment -> status = 'cancelled' */\r\nexport async function cancelAppointment(clinicId, appointmentId, cancelledByEmail = null) {\r\n  return updateAppointment(clinicId, appointmentId, { status: 'cancelled', cancelledBy: cancelledByEmail, cancelledAt: new Date().toISOString() });\r\n}\r\n\r\n/* delete appointment (if needed) */\r\nexport async function deleteAppointment(clinicId, appointmentId) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const ref = doc(db, 'clinics', clinicId, 'appointments', String(appointmentId));\r\n  await deleteDoc(ref);\r\n  return true;\r\n}\r\n\r\n/* ============================\r\n   Date-based appointment helpers\r\n   ============================ */\r\n\r\n/**\r\n * Fetch appointments for a specific date (ISO date string or Date object)\r\n * Returns appointments ordered by scheduledAt ascending.\r\n */\r\nexport async function fetchAppointmentsByDate(clinicId, date) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const d = (date instanceof Date) ? date : new Date(date);\r\n  const start = new Date(d); start.setHours(0,0,0,0);\r\n  const end = new Date(d); end.setHours(23,59,59,999);\r\n\r\n  const coll = appointmentsCollectionRef(clinicId);\r\n  const q = query(coll, where('scheduledAt', '>=', start.toISOString()), where('scheduledAt', '<=', end.toISOString()));\r\n  const snap = await getDocs(q);\r\n  const items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));\r\n  items.sort((a,b) => (a.scheduledAt || '').localeCompare(b.scheduledAt || ''));\r\n  return items;\r\n}\r\n\r\n/**\r\n * Subscribe to appointments for a specific date (real-time)\r\n * callback(items) on update\r\n */\r\nexport function subscribeAppointmentsByDate(clinicId, date, callback, onError) {\r\n  if (!clinicId) {\r\n    if (onError) onError(new Error('clinicId required'));\r\n    return () => {};\r\n  }\r\n  const d = (date instanceof Date) ? date : new Date(date);\r\n  const start = new Date(d); start.setHours(0,0,0,0);\r\n  const end = new Date(d); end.setHours(23,59,59,999);\r\n\r\n  const coll = appointmentsCollectionRef(clinicId);\r\n  const q = query(coll, where('scheduledAt', '>=', start.toISOString()), where('scheduledAt', '<=', end.toISOString()));\r\n  const unsub = onSnapshot(q, (snap) => {\r\n    const items = snap.docs.map(dd => ({ id: dd.id, ...dd.data() }));\r\n    items.sort((a,b) => (a.scheduledAt || '').localeCompare(b.scheduledAt || ''));\r\n    callback(items);\r\n  }, (err) => {\r\n    console.error('subscribeAppointmentsByDate error', err);\r\n    if (onError) onError(err);\r\n  });\r\n  return unsub;\r\n}\r\n\r\n/* ============================\r\n   Consultations\r\n   ============================ */\r\n\r\n/**\r\n * Create consultation document.\r\n * ID format: YYYYMMDDHHMMSS-<NIC>\r\n */\r\nexport async function createConsultation(clinicId, {\r\n  patientNic,\r\n  appointmentId = null,\r\n  doctorEmail = null,\r\n  presentComplaint = '',\r\n  examFindings = '',\r\n  differentialDiagnosis = '',\r\n  investigations = '',\r\n  management = ''\r\n} = {}) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!patientNic) throw new Error('patientNic required');\r\n\r\n  const now = new Date();\r\n  const id = formatDateToId(now) + '-' + String(patientNic);\r\n  const ref = doc(db, 'clinics', clinicId, 'consultations', id);\r\n\r\n  const docData = {\r\n    patientNic: String(patientNic),\r\n    appointmentId: appointmentId ?? null,\r\n    doctorEmail: doctorEmail ?? null,\r\n    presentComplaint,\r\n    examFindings,\r\n    differentialDiagnosis,\r\n    investigations,\r\n    management,\r\n    createdAt: now.toISOString(),\r\n    updatedAt: now.toISOString()\r\n  };\r\n\r\n  await setDoc(ref, docData, { merge: false });\r\n  return { id, ...docData };\r\n}\r\n\r\n/**\r\n * Fetch consultations for a patient (latest first)\r\n */\r\nexport async function fetchConsultationsForPatient(clinicId, patientNic) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!patientNic) throw new Error('patientNic required');\r\n\r\n  const coll = consultationsCollectionRef(clinicId);\r\n  const q = query(coll, where('patientNic', '==', String(patientNic)));\r\n  const snap = await getDocs(q);\r\n  const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n  items.sort((a,b) => (b.createdAt || '').localeCompare(a.createdAt || ''));\r\n  return items;\r\n}\r\n\r\n/**\r\n * Subscribe consultations for a patient (real-time)\r\n */\r\nexport function subscribeConsultationsForPatient(clinicId, patientNic, callback, onError) {\r\n  if (!clinicId) {\r\n    if (onError) onError(new Error('clinicId required'));\r\n    return () => {};\r\n  }\r\n  const coll = consultationsCollectionRef(clinicId);\r\n  const q = query(coll, where('patientNic', '==', String(patientNic)));\r\n  const unsub = onSnapshot(q, (snap) => {\r\n    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n    items.sort((a,b) => (b.createdAt || '').localeCompare(a.createdAt || ''));\r\n    callback(items);\r\n  }, (err) => {\r\n    console.error('subscribeConsultationsForPatient error', err);\r\n    if (onError) onError(err);\r\n  });\r\n  return unsub;\r\n}\r\n\r\n/* ============================\r\n   Prescriptions\r\n   ============================ */\r\n\r\n/**\r\n * Create prescription document (doctor creates from consultation)\r\n * id format: YYYYMMDDHHMMSS-<NIC>\r\n * Stored under clinics/{clinicId}/prescriptions/{prescId}\r\n */\r\nexport async function createPrescription(clinicId, { consultationId = null, patientNic, doctorEmail = null, rawManagement = '', items = [] } = {}) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!patientNic) throw new Error('patientNic required');\r\n\r\n  const now = new Date();\r\n  const prescId = formatDateToId(now) + '-' + String(patientNic);\r\n  const ref = doc(db, 'clinics', clinicId, 'prescriptions', prescId);\r\n\r\n  // compute subtotal if items provided\r\n  let subtotal = 0;\r\n  const normalizedItems = (Array.isArray(items) ? items : []).map(it => {\r\n    const unitPrice = Number(it.unitPrice || 0) || 0;\r\n    const qty = Number(it.qty || 0) || 0;\r\n    const lineTotal = unitPrice * qty;\r\n    subtotal += lineTotal;\r\n    return {\r\n      drugId: it.drugId ?? null,\r\n      drugName: it.drugName ?? (it.name ?? ''),\r\n      dose: it.dose ?? '',\r\n      qty,\r\n      unitPrice,\r\n      lineTotal,\r\n      raw: it.raw ?? null\r\n    };\r\n  });\r\n\r\n  const docData = {\r\n    consultationId,\r\n    patientNic: String(patientNic),\r\n    doctorEmail: doctorEmail ?? null,\r\n    rawManagement: rawManagement ?? '',\r\n    items: normalizedItems,\r\n    subtotal,\r\n    tax: 0,\r\n    total: subtotal,\r\n    status: 'pending',\r\n    createdAt: now.toISOString()\r\n  };\r\n\r\n  await setDoc(ref, docData, { merge: false });\r\n  return { id: prescId, ...docData };\r\n}\r\n\r\n/**\r\n * Subscribe pending prescriptions (pharmacist)\r\n */\r\nexport function subscribePendingPrescriptions(clinicId, callback, onError) {\r\n  if (!clinicId) {\r\n    if (onError) onError(new Error('clinicId required'));\r\n    return () => {};\r\n  }\r\n  const coll = prescriptionsCollectionRef(clinicId);\r\n  const q = query(coll, where('status', '==', 'pending'), orderBy('createdAt', 'asc'));\r\n  const unsub = onSnapshot(q, (snap) => {\r\n    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n    callback(items);\r\n  }, (err) => {\r\n    console.error('subscribePendingPrescriptions error', err);\r\n    if (onError) onError(err);\r\n  });\r\n  return unsub;\r\n}\r\n\r\n/* ============================\r\n   Drugs (inventory)\r\n   ============================ */\r\n\r\n/* Subscribe / fetch drugs list */\r\nexport function subscribeDrugs(clinicId, callback, onError) {\r\n  if (!clinicId) {\r\n    if (onError) onError(new Error('clinicId required'));\r\n    return () => {};\r\n  }\r\n  const coll = drugsCollectionRef(clinicId);\r\n  const q = query(coll, orderBy('name', 'asc'));\r\n  const unsub = onSnapshot(q, (snap) => {\r\n    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n    callback(items);\r\n  }, onError);\r\n  return unsub;\r\n}\r\n\r\nexport async function fetchDrugsOnce(clinicId) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const coll = drugsCollectionRef(clinicId);\r\n  const q = query(coll, orderBy('name', 'asc'));\r\n  const snap = await getDocs(q);\r\n  return snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n}\r\n\r\nexport async function createOrUpdateDrug(clinicId, drugIdOrName, { name, dose, qtyAvailable = 0, pricePerUnit = 0, updatedBy = null } = {}) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const id = String(drugIdOrName).trim();\r\n  const ref = doc(db, 'clinics', clinicId, 'drugs', id);\r\n  const payload = {\r\n    name: name ?? id,\r\n    dose: dose ?? '',\r\n    qtyAvailable: Number(qtyAvailable) || 0,\r\n    pricePerUnit: Number(pricePerUnit) || 0,\r\n    updatedAt: new Date().toISOString(),\r\n    updatedBy: updatedBy ?? null\r\n  };\r\n  await setDoc(ref, payload, { merge: true });\r\n  return { id, ...payload };\r\n}\r\n\r\n/* ============================\r\n   Stock transactions: decrement / increment\r\n   ============================ */\r\n\r\n/**\r\n * Decrement drug stock atomically using a transaction.\r\n * Ensures stock never goes negative.\r\n *\r\n * Returns the new qtyAvailable after decrement.\r\n */\r\nexport async function decrementDrugStock(clinicId, drugId, decQty = 1) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!drugId) throw new Error('drugId required');\r\n  decQty = Number(decQty) || 0;\r\n  if (decQty <= 0) throw new Error('decQty must be > 0');\r\n\r\n  const drugRef = doc(db, 'clinics', clinicId, 'drugs', String(drugId));\r\n\r\n  const result = await runTransaction(db, async (tx) => {\r\n    const snap = await tx.get(drugRef);\r\n    if (!snap.exists()) throw new Error('Drug not found');\r\n    const data = snap.data();\r\n    const current = Number(data.qtyAvailable || 0);\r\n    if (current < decQty) throw new Error(`Insufficient stock for ${data.name || drugId} (need ${decQty}, have ${current})`);\r\n    const newQty = current - decQty;\r\n    tx.update(drugRef, { qtyAvailable: newQty, updatedAt: new Date().toISOString() });\r\n    return newQty;\r\n  });\r\n\r\n  return result; // number\r\n}\r\n\r\n/**\r\n * Increment drug stock atomically using a transaction.\r\n * Use when removing items from cart / restocking.\r\n *\r\n * @returns {number} newQty\r\n */\r\nexport async function incrementDrugStock(clinicId, drugId, incQty = 1) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!drugId) throw new Error('drugId required');\r\n  incQty = Number(incQty) || 0;\r\n  if (incQty <= 0) throw new Error('incQty must be > 0');\r\n\r\n  const drugRef = doc(db, 'clinics', clinicId, 'drugs', String(drugId));\r\n\r\n  const result = await runTransaction(db, async (tx) => {\r\n    const snap = await tx.get(drugRef);\r\n    if (!snap.exists()) throw new Error('Drug not found');\r\n    const data = snap.data();\r\n    const current = Number(data.qtyAvailable || 0);\r\n    const newQty = current + incQty;\r\n    tx.update(drugRef, { qtyAvailable: newQty, updatedAt: new Date().toISOString() });\r\n    return newQty;\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/* ============================\r\n   Issue prescription transaction\r\n   ============================ */\r\n\r\n/**\r\n * issuePrescriptionTransaction\r\n * - clinicId\r\n * - prescriptionId\r\n * - pharmacistEmail\r\n * - items: [{ drugId, qty }]  // items to issue; caller should provide qty and drugId\r\n *\r\n * Behavior (atomic transaction):\r\n *  - verify prescription exists and is pending\r\n *  - load each drug doc and ensure qtyAvailable >= qty requested\r\n *  - decrement qtyAvailable for each drug\r\n *  - create invoice doc (id format formatDateToId + -patientNic)\r\n *  - update prescription status -> 'issued', set issuedAt, issuedBy, invoiceId\r\n *  - return invoice summary\r\n */\r\nexport async function issuePrescriptionTransaction(clinicId, prescriptionId, pharmacistEmail, items = []) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!prescriptionId) throw new Error('prescriptionId required');\r\n  if (!Array.isArray(items) || items.length === 0) throw new Error('items required');\r\n\r\n  const prescRef = doc(db, 'clinics', clinicId, 'prescriptions', prescriptionId);\r\n\r\n  const result = await runTransaction(db, async (tx) => {\r\n    const prescSnap = await tx.get(prescRef);\r\n    if (!prescSnap.exists()) throw new Error('Prescription not found');\r\n    const presc = prescSnap.data();\r\n\r\n    if (presc.status === 'issued') throw new Error('Prescription already issued');\r\n\r\n    // Prepare drug refs and read them\r\n    const drugRefs = items.map(i => doc(db, 'clinics', clinicId, 'drugs', String(i.drugId)));\r\n    const drugSnaps = [];\r\n    for (const r of drugRefs) {\r\n      const s = await tx.get(r);\r\n      drugSnaps.push(s);\r\n    }\r\n\r\n    // Check availability\r\n    for (let i = 0; i < items.length; i++) {\r\n      const it = items[i];\r\n      const snap = drugSnaps[i];\r\n      if (!snap.exists()) throw new Error(`Drug not found: ${it.drugId}`);\r\n      const d = snap.data();\r\n      const available = Number(d.qtyAvailable || 0);\r\n      const needed = Number(it.qty || 0);\r\n      if (needed <= 0) throw new Error(`Invalid qty for ${it.drugId}`);\r\n      if (available < needed) throw new Error(`Insufficient stock for ${d.name} (need ${needed}, have ${available})`);\r\n    }\r\n\r\n    // Compute line items and totals\r\n    const lineItems = [];\r\n    let subtotal = 0;\r\n    for (let i = 0; i < items.length; i++) {\r\n      const it = items[i];\r\n      const snap = drugSnaps[i];\r\n      const d = snap.data();\r\n      const unitPrice = Number(d.pricePerUnit || 0);\r\n      const qty = Number(it.qty || 0);\r\n      const lineTotal = unitPrice * qty;\r\n      subtotal += lineTotal;\r\n      lineItems.push({\r\n        drugId: String(it.drugId),\r\n        drugName: d.name,\r\n        dose: d.dose || '',\r\n        qty,\r\n        unitPrice,\r\n        lineTotal\r\n      });\r\n    }\r\n\r\n    // Create invoice id\r\n    const now = new Date();\r\n    const invoiceId = formatDateToId(now) + '-' + String(presc.patientNic || 'unknown');\r\n\r\n    const invRef = doc(db, 'clinics', clinicId, 'invoices', invoiceId);\r\n\r\n    const invoiceDoc = {\r\n      prescriptionId,\r\n      patientNic: presc.patientNic,\r\n      pharmacistEmail,\r\n      createdAt: now.toISOString(),\r\n      items: lineItems,\r\n      subtotal,\r\n      tax: 0,\r\n      total: subtotal,\r\n      status: 'unpaid'\r\n    };\r\n\r\n    // Decrement stocks\r\n    for (let i = 0; i < items.length; i++) {\r\n      const it = items[i];\r\n      const r = drugRefs[i];\r\n      const snap = drugSnaps[i];\r\n      const current = Number(snap.data().qtyAvailable || 0);\r\n      const newQty = current - Number(it.qty || 0);\r\n      tx.update(r, { qtyAvailable: newQty, updatedAt: new Date().toISOString() });\r\n    }\r\n\r\n    // Create invoice\r\n    tx.set(invRef, invoiceDoc);\r\n\r\n    // Update prescription to issued\r\n    tx.update(prescRef, {\r\n      status: 'issued',\r\n      issuedAt: now.toISOString(),\r\n      issuedBy: pharmacistEmail,\r\n      invoiceId\r\n    });\r\n\r\n    // Optionally link invoiceId into consultation doc\r\n    if (presc.consultationId) {\r\n      const consultRef = doc(db, 'clinics', clinicId, 'consultations', presc.consultationId);\r\n      const consultSnap = await tx.get(consultRef);\r\n      if (consultSnap.exists()) {\r\n        tx.update(consultRef, { invoiceId });\r\n      }\r\n    }\r\n\r\n    return {\r\n      invoiceId,\r\n      invoice: invoiceDoc\r\n    };\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/* ============================\r\n   Fetch helpers: one-off / subscription\r\n   ============================ */\r\n\r\n/* -- already have subscribePatients, subscribeDrugs, subscribePendingPrescriptions, subscribeConsultationsForPatient, etc. -- */\r\n\r\n/* Provide fetch functions for invoices if needed */\r\nexport async function fetchInvoicesForPatient(clinicId, patientNic) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!patientNic) throw new Error('patientNic required');\r\n  const coll = invoicesCollectionRef(clinicId);\r\n  const q = query(coll, where('patientNic', '==', String(patientNic)));\r\n  const snap = await getDocs(q);\r\n  return snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n}\r\n\r\n/* ============================\r\n   Exports (already named exports above)\r\n   ============================ */\r\n\r\n// Note: all functions are exported as named exports above.\r\n// No default export.\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 839, "column": 0}, "map": {"version":3,"sources":["file:///D:/Education/WebDev%20with%20AI/Projects/clinic-suite/components/PharmacyCenter.js"],"sourcesContent":["// components/PharmacyCenter.js\r\n'use client';\r\n\r\nimport React, { useState, useMemo } from 'react';\r\nimport { decrementDrugStock, incrementDrugStock } from '../lib/firestoreClient';\r\n\r\nexport default function PharmacyCenter({ clinicId, drugs = [], prescription = null, pharmacistEmail }) {\r\n  const [q, setQ] = useState('');\r\n  const [qtyMap, setQtyMap] = useState({}); // drugId -> qty (input)\r\n  const [cart, setCart] = useState([]); // invoice items: { drugId, drugName, dose, qty, unitPrice, lineTotal }\r\n  const [busy, setBusy] = useState(false);\r\n  const [msg, setMsg] = useState(null);\r\n\r\n  const filtered = useMemo(() => {\r\n    const term = (q || '').trim().toLowerCase();\r\n    if (!term) return drugs;\r\n    return drugs.filter(d => (d.name || '').toLowerCase().includes(term) || (d.dose || '').toLowerCase().includes(term));\r\n  }, [q, drugs]);\r\n\r\n  function setQty(drugId, val) {\r\n    const n = Number(val || 0);\r\n    setQtyMap(prev => ({ ...prev, [drugId]: n }));\r\n  }\r\n\r\n  async function handleAdd(drug) {\r\n    const drugId = drug.id;\r\n    const qty = Number(qtyMap[drugId] || 0);\r\n    if (!qty || qty <= 0) {\r\n      alert('Enter a valid quantity (>0)');\r\n      return;\r\n    }\r\n    if (!clinicId) {\r\n      alert('Missing clinic context');\r\n      return;\r\n    }\r\n    setBusy(true);\r\n    setMsg(null);\r\n    try {\r\n      // decrement stock atomically\r\n      const newQty = await decrementDrugStock(clinicId, drugId, qty);\r\n\r\n      // add to cart (merge if exists)\r\n      const unitPrice = Number(drug.pricePerUnit || 0);\r\n      setCart(prev => {\r\n        const existing = prev.find(p => p.drugId === drugId);\r\n        if (existing) {\r\n          return prev.map(p => p.drugId === drugId ? { ...p, qty: p.qty + qty, lineTotal: (p.qty + qty) * p.unitPrice } : p);\r\n        }\r\n        return [...prev, { drugId, drugName: drug.name, dose: drug.dose || '', qty, unitPrice, lineTotal: unitPrice * qty }];\r\n      });\r\n\r\n      setMsg({ type: 'success', text: `Added ${qty} x ${drug.name}. New stock: ${newQty}` });\r\n      setQtyMap(prev => ({ ...prev, [drugId]: 0 }));\r\n    } catch (err) {\r\n      console.error(err);\r\n      setMsg({ type: 'error', text: err?.message || String(err) });\r\n    } finally {\r\n      setBusy(false);\r\n    }\r\n  }\r\n\r\n  // update quantity in cart (adjust stock for difference)\r\n  async function updateCartQty(drugId, newQty) {\r\n    newQty = Number(newQty || 0);\r\n    const item = cart.find(c => c.drugId === drugId);\r\n    if (!item) return;\r\n\r\n    const oldQty = Number(item.qty || 0);\r\n    if (newQty === oldQty) return;\r\n\r\n    if (newQty <= 0) {\r\n      // same as removing the item\r\n      return removeFromCart(drugId);\r\n    }\r\n\r\n    const delta = newQty - oldQty; // positive => need to decrement stock, negative => increment stock\r\n    setBusy(true);\r\n    setMsg(null);\r\n    try {\r\n      if (delta > 0) {\r\n        // need to decrement additional stocks\r\n        await decrementDrugStock(clinicId, drugId, delta);\r\n      } else if (delta < 0) {\r\n        // return stock to inventory\r\n        await incrementDrugStock(clinicId, drugId, Math.abs(delta));\r\n      }\r\n\r\n      // update cart item\r\n      setCart(prev => prev.map(p => p.drugId === drugId ? { ...p, qty: newQty, lineTotal: newQty * p.unitPrice } : p));\r\n      setMsg({ type: 'success', text: `Updated ${item.drugName} quantity to ${newQty}.` });\r\n    } catch (err) {\r\n      console.error(err);\r\n      setMsg({ type: 'error', text: err?.message || String(err) });\r\n    } finally {\r\n      setBusy(false);\r\n    }\r\n  }\r\n\r\n  // remove item and restock its qty\r\n  async function removeFromCart(drugId) {\r\n    const item = cart.find(c => c.drugId === drugId);\r\n    if (!item) return;\r\n    if (!confirm(`Remove ${item.qty} x ${item.drugName} from invoice and restock?`)) return;\r\n\r\n    setBusy(true);\r\n    setMsg(null);\r\n    try {\r\n      await incrementDrugStock(clinicId, drugId, item.qty);\r\n      setCart(prev => prev.filter(p => p.drugId !== drugId));\r\n      setMsg({ type: 'success', text: `Removed ${item.drugName} and restored ${item.qty} to stock.` });\r\n    } catch (err) {\r\n      console.error(err);\r\n      setMsg({ type: 'error', text: err?.message || String(err) });\r\n    } finally {\r\n      setBusy(false);\r\n    }\r\n  }\r\n\r\n  function computeTotal() {\r\n    return cart.reduce((s, it) => s + (Number(it.lineTotal) || 0), 0);\r\n  }\r\n\r\n  // Print invoice (A5) using hidden iframe (like prescription)\r\n  function printInvoice() {\r\n    if (cart.length === 0) {\r\n      alert('Invoice is empty.');\r\n      return;\r\n    }\r\n    const now = new Date();\r\n    const clinicName = clinicId || 'Clinic';\r\n    const patientName = prescription?.patientNic ?? '-';\r\n    const docHtml = buildInvoiceHtml({ clinicName, patientName, cart, pharmacistEmail, now });\r\n    // create hidden iframe and print\r\n    try {\r\n      const iframe = document.createElement('iframe');\r\n      iframe.style.position = 'fixed';\r\n      iframe.style.right = '0';\r\n      iframe.style.bottom = '0';\r\n      iframe.style.width = '0';\r\n      iframe.style.height = '0';\r\n      iframe.style.border = '0';\r\n      iframe.style.visibility = 'hidden';\r\n      document.body.appendChild(iframe);\r\n\r\n      const iframeDoc = iframe.contentWindow || iframe.contentDocument;\r\n      const doc = (iframeDoc.document) ? iframeDoc.document : iframeDoc;\r\n\r\n      doc.open();\r\n      doc.write(docHtml);\r\n      doc.close();\r\n\r\n      setTimeout(() => {\r\n        try {\r\n          iframe.contentWindow.focus();\r\n          iframe.contentWindow.print();\r\n        } catch (err) {\r\n          console.error('Print failed', err);\r\n          alert('Printing failed. Try browser print dialog or allow popups.');\r\n        } finally {\r\n          setTimeout(() => { try { document.body.removeChild(iframe); } catch(_) {} }, 500);\r\n        }\r\n      }, 300);\r\n    } catch (err) {\r\n      console.error('printInvoice error', err);\r\n      alert('Unable to print. Check browser settings.');\r\n    }\r\n  }\r\n\r\n  function buildInvoiceHtml({ clinicName, patientName, cart, pharmacistEmail, now }) {\r\n    const escaped = (s) => {\r\n      if (s === null || s === undefined) return '';\r\n      return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('\"', '&quot;').replaceAll(\"'\", '&#039;');\r\n    };\r\n    const rows = cart.map(it => `\r\n      <tr>\r\n        <td style=\"padding:6px 8px;border-bottom:1px solid #ddd;\">${escaped(it.drugName)}</td>\r\n        <td style=\"padding:6px 8px;border-bottom:1px solid #ddd;\">${escaped(it.dose)}</td>\r\n        <td style=\"padding:6px 8px;border-bottom:1px solid #ddd;text-align:right;\">${escaped(String(it.qty))}</td>\r\n        <td style=\"padding:6px 8px;border-bottom:1px solid #ddd;text-align:right;\">${escaped(Number(it.unitPrice).toFixed(2))}</td>\r\n        <td style=\"padding:6px 8px;border-bottom:1px solid #ddd;text-align:right;\">${escaped(Number(it.lineTotal).toFixed(2))}</td>\r\n      </tr>\r\n    `).join('');\r\n\r\n    const total = computeTotal().toFixed(2);\r\n\r\n    return `<!doctype html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <title>Invoice - ${escaped(patientName)}</title>\r\n  <style>\r\n    @page { size: A5; margin: 12mm; }\r\n    body { font-family: Arial, Helvetica, sans-serif; color: #111; font-size: 12px; margin:0; padding:8mm; box-sizing:border-box; }\r\n    .header { text-align:center; margin-bottom:8px; }\r\n    .clinic { font-weight:700; font-size:14px; }\r\n    table { width:100%; border-collapse:collapse; margin-top:6px; }\r\n    th { text-align:left; padding:6px 8px; border-bottom:1px solid #ddd; font-size:12px; }\r\n    td { font-size:12px; }\r\n    .total { text-align:right; font-weight:700; margin-top:8px; }\r\n    .footer { text-align:center; margin-top:12px; font-size:11px; }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"header\">\r\n    <div class=\"clinic\">${escaped(clinicName)}</div>\r\n    <div class=\"meta\">Drug Invoice</div>\r\n  </div>\r\n\r\n  <div>\r\n    <div><strong>Patient:</strong> ${escaped(patientName)}</div>\r\n    <div><strong>Date:</strong> ${escaped(now.toLocaleString())}</div>\r\n  </div>\r\n\r\n  <table>\r\n    <thead>\r\n      <tr>\r\n        <th style=\"width:40%;\">Drug</th>\r\n        <th style=\"width:20%;\">Dose</th>\r\n        <th style=\"width:10%;\">Qty</th>\r\n        <th style=\"width:15%;text-align:right;\">Unit</th>\r\n        <th style=\"width:15%;text-align:right;\">Total</th>\r\n      </tr>\r\n    </thead>\r\n    <tbody>\r\n      ${rows}\r\n    </tbody>\r\n  </table>\r\n\r\n  <div class=\"total\">TOTAL: LKR ${escaped(total)}</div>\r\n\r\n  <div class=\"footer\">Pharmacist: ${escaped(pharmacistEmail || '')}</div>\r\n</body>\r\n</html>`;\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Drug stock + search */}\r\n      <div className=\"rounded-xl bg-white p-4 shadow-sm\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <div className=\"text-sm font-medium text-slate-800\">Drug stock</div>\r\n            <div className=\"text-xs text-slate-500\">Search and add to invoice</div>\r\n          </div>\r\n          <div>\r\n            <input value={q} onChange={(e) => setQ(e.target.value)} placeholder=\"Search by name or dose\" className=\"p-2 border rounded\" />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-3 max-h-56 overflow-auto\">\r\n          {filtered.length === 0 && <div className=\"text-sm text-slate-400\">No drugs found</div>}\r\n          <div className=\"space-y-2\">\r\n            {filtered.map(d => (\r\n              <div key={d.id} className=\"flex items-center justify-between p-2 border rounded\">\r\n                <div>\r\n                  <div className=\"font-medium\">{d.name} <span className=\"text-xs text-slate-400\">({d.dose})</span></div>\r\n                  <div className=\"text-xs text-slate-500\">Qty: {d.qtyAvailable ?? 0} • LKR {Number(d.pricePerUnit || 0).toFixed(2)}</div>\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-2\">\r\n                  <input\r\n                    type=\"number\"\r\n                    min=\"1\"\r\n                    value={qtyMap[d.id] || ''}\r\n                    onChange={(e) => setQty(d.id, e.target.value)}\r\n                    className=\"w-20 p-1 border rounded\"\r\n                    placeholder=\"qty\"\r\n                  />\r\n                  <button disabled={busy} onClick={() => handleAdd(d)} className=\"px-3 py-1 rounded border text-sm\">\r\n                    Add\r\n                  </button>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Drug Invoice card */}\r\n      <div className=\"rounded-xl bg-white p-4 shadow-sm\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <div className=\"text-sm font-medium text-slate-800\">Drug Invoice</div>\r\n            <div className=\"text-xs text-slate-500\">Items added will reduce stock immediately</div>\r\n          </div>\r\n          <div>\r\n            <button onClick={() => { setCart([]); setMsg(null); }} className=\"px-2 py-1 rounded border text-sm\">Clear</button>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-3\">\r\n          {cart.length === 0 && <div className=\"text-sm text-slate-400\">No items in invoice</div>}\r\n          {cart.map(item => (\r\n            <div key={item.drugId} className=\"flex items-center justify-between p-2 border rounded mb-2\">\r\n              <div>\r\n                <div className=\"font-medium\">{item.drugName}</div>\r\n                <div className=\"text-xs text-slate-500\">{item.dose}</div>\r\n              </div>\r\n              <div className=\"flex items-center gap-2\">\r\n                <input type=\"number\" min=\"1\" value={item.qty} onChange={(e) => updateCartQty(item.drugId, Number(e.target.value || 0))} className=\"w-20 p-1 border rounded\" />\r\n                <div className=\"text-sm w-28 text-right\">LKR {Number(item.unitPrice).toFixed(2)}</div>\r\n                <div className=\"text-sm w-36 text-right\">LKR {Number(item.lineTotal).toFixed(2)}</div>\r\n                <button onClick={() => removeFromCart(item.drugId)} className=\"px-2 py-1 rounded border text-sm\">Remove</button>\r\n              </div>\r\n            </div>\r\n          ))}\r\n\r\n          <div className=\"mt-3 flex justify-between items-center\">\r\n            <div className=\"text-sm font-medium\">Total: LKR {computeTotal().toFixed(2)}</div>\r\n            <div>\r\n              <button disabled={cart.length === 0} onClick={printInvoice} className=\"px-3 py-2 rounded bg-indigo-600 text-white\">\r\n                Print Invoice\r\n              </button>\r\n            </div>\r\n          </div>\r\n\r\n          {msg && (\r\n            <div className={`mt-3 p-2 rounded ${msg.type === 'success' ? 'bg-green-50 border border-green-200 text-green-700' : 'bg-red-50 border border-red-200 text-red-700'}`}>\r\n              {msg.text}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1512, "column": 0}, "map": {"version":3,"sources":["file:///D:/Education/WebDev%20with%20AI/Projects/clinic-suite/components/PharmacyQuickActions.js"],"sourcesContent":["// components/PharmacyQuickActions.js\r\n'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { useAuth } from './AuthProvider';\r\nimport { createOrUpdateDrug } from '../lib/firestoreClient';\r\n\r\nexport default function PharmacyQuickActions({ clinicId, refresh = () => {} }) {\r\n  const [busy, setBusy] = useState(false);\r\n  const { claims, loading } = useAuth();\r\n\r\n  async function seedSampleDrugs() {\r\n    if (loading) {\r\n      alert('Auth still loading — try again in a moment.');\r\n      return;\r\n    }\r\n\r\n    if (!clinicId) {\r\n      alert('Missing clinic context (clinicId).');\r\n      return;\r\n    }\r\n\r\n    // restrict to pharmacist/admin to reduce permission failures\r\n    const role = claims?.role;\r\n    if (!role || !['pharmacist', 'admin'].includes(role)) {\r\n      if (!confirm('You are not a pharmacist/admin. Attempt to seed anyway?')) return;\r\n    }\r\n\r\n    if (!confirm('Create 5 sample drugs (1000 qty each)? This will create or update the drug docs.')) return;\r\n\r\n    setBusy(true);\r\n    try {\r\n      const sample = [\r\n        { id: 'paracetamol_500mg', name: 'Paracetamol', dose: '500mg', qtyAvailable: 1000, pricePerUnit: 5 },\r\n        { id: 'omeprazole_20mg', name: 'Omeprazole', dose: '20mg', qtyAvailable: 1000, pricePerUnit: 30 },\r\n        { id: 'domperidone_10mg', name: 'Domperidone', dose: '10mg', qtyAvailable: 1000, pricePerUnit: 8 },\r\n        { id: 'cetirizine_10mg', name: 'Cetirizine', dose: '10mg', qtyAvailable: 1000, pricePerUnit: 6 },\r\n        { id: 'pirion_4mg', name: 'Pirion', dose: '4mg', qtyAvailable: 1000, pricePerUnit: 12 }\r\n      ];\r\n\r\n      for (const s of sample) {\r\n        // createOrUpdateDrug will set/merge the document\r\n        await createOrUpdateDrug(clinicId, s.id, {\r\n          name: s.name,\r\n          dose: s.dose,\r\n          qtyAvailable: s.qtyAvailable,\r\n          pricePerUnit: s.pricePerUnit,\r\n          updatedBy: claims?.email ?? null\r\n        });\r\n      }\r\n\r\n      alert('Sample drugs created/updated successfully.');\r\n      refresh();\r\n    } catch (err) {\r\n      console.error('Seeding failed', err);\r\n      alert('Seeding failed: ' + (err?.message || String(err)));\r\n    } finally {\r\n      setBusy(false);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"rounded-xl bg-white p-4 shadow-sm\">\r\n      <div className=\"text-sm font-medium text-slate-800\">Quick actions</div>\r\n      <div className=\"mt-3 flex flex-col gap-2\">\r\n        <button\r\n          onClick={seedSampleDrugs}\r\n          disabled={busy}\r\n          className={`px-3 py-2 rounded border text-sm ${busy ? 'opacity-60 cursor-not-allowed' : ''}`}\r\n        >\r\n          {busy ? 'Seeding...' : 'Seed sample drugs (5 x 1000)'}\r\n        </button>\r\n\r\n        <button\r\n          onClick={() => window.location.reload()}\r\n          className=\"px-3 py-2 rounded border text-sm\"\r\n        >\r\n          Refresh page\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"AAAA,qCAAqC;;;;;;AAGrC;AACA;AACA;;;AAJA;;;;AAMe,SAAS,qBAAqB,EAAE,QAAQ,EAAE,UAAU,KAAO,CAAC,EAAE;;IAC3E,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,4LAAQ,EAAC;IACjC,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,GAAG,IAAA,2JAAO;IAEnC,eAAe;QACb,IAAI,SAAS;YACX,MAAM;YACN;QACF;QAEA,IAAI,CAAC,UAAU;YACb,MAAM;YACN;QACF;QAEA,6DAA6D;QAC7D,MAAM,OAAO,QAAQ;QACrB,IAAI,CAAC,QAAQ,CAAC;YAAC;YAAc;SAAQ,CAAC,QAAQ,CAAC,OAAO;YACpD,IAAI,CAAC,QAAQ,4DAA4D;QAC3E;QAEA,IAAI,CAAC,QAAQ,qFAAqF;QAElG,QAAQ;QACR,IAAI;YACF,MAAM,SAAS;gBACb;oBAAE,IAAI;oBAAqB,MAAM;oBAAe,MAAM;oBAAS,cAAc;oBAAM,cAAc;gBAAE;gBACnG;oBAAE,IAAI;oBAAmB,MAAM;oBAAc,MAAM;oBAAQ,cAAc;oBAAM,cAAc;gBAAG;gBAChG;oBAAE,IAAI;oBAAoB,MAAM;oBAAe,MAAM;oBAAQ,cAAc;oBAAM,cAAc;gBAAE;gBACjG;oBAAE,IAAI;oBAAmB,MAAM;oBAAc,MAAM;oBAAQ,cAAc;oBAAM,cAAc;gBAAE;gBAC/F;oBAAE,IAAI;oBAAc,MAAM;oBAAU,MAAM;oBAAO,cAAc;oBAAM,cAAc;gBAAG;aACvF;YAED,KAAK,MAAM,KAAK,OAAQ;gBACtB,iDAAiD;gBACjD,MAAM,IAAA,kKAAkB,EAAC,UAAU,EAAE,EAAE,EAAE;oBACvC,MAAM,EAAE,IAAI;oBACZ,MAAM,EAAE,IAAI;oBACZ,cAAc,EAAE,YAAY;oBAC5B,cAAc,EAAE,YAAY;oBAC5B,WAAW,QAAQ,SAAS;gBAC9B;YACF;YAEA,MAAM;YACN;QACF,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,kBAAkB;YAChC,MAAM,qBAAqB,CAAC,KAAK,WAAW,OAAO,IAAI;QACzD,SAAU;YACR,QAAQ;QACV;IACF;IAEA,qBACE,gNAAC;QAAI,WAAU;;0BACb,gNAAC;gBAAI,WAAU;0BAAqC;;;;;;0BACpD,gNAAC;gBAAI,WAAU;;kCACb,gNAAC;wBACC,SAAS;wBACT,UAAU;wBACV,WAAW,CAAC,iCAAiC,EAAE,OAAO,kCAAkC,IAAI;kCAE3F,OAAO,eAAe;;;;;;kCAGzB,gNAAC;wBACC,SAAS,IAAM,OAAO,QAAQ,CAAC,MAAM;wBACrC,WAAU;kCACX;;;;;;;;;;;;;;;;;;AAMT;GA3EwB;;QAEM,2JAAO;;;KAFb"}},
    {"offset": {"line": 1668, "column": 0}, "map": {"version":3,"sources":["file:///D:/Education/WebDev%20with%20AI/Projects/clinic-suite/app/pharmacy/page.js"],"sourcesContent":["// app/pharmacy/page.js\r\n'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport { useAuth } from '../../components/AuthProvider';\r\nimport PharmacySidebar from '../../components/PharmacySidebar';\r\nimport PharmacyCenter from '../../components/PharmacyCenter';\r\nimport PharmacyQuickActions from '../../components/PharmacyQuickActions';\r\nimport { subscribePendingPrescriptions, subscribeDrugs } from '../../lib/firestoreClient';\r\n\r\nexport default function PharmacyPage() {\r\n  const { user, claims, loading } = useAuth();\r\n  const [prescriptions, setPrescriptions] = useState([]);\r\n  const [drugs, setDrugs] = useState([]);\r\n  const [selectedPrescription, setSelectedPrescription] = useState(null);\r\n  const [error, setError] = useState(null);\r\n\r\n  const clinicId = claims?.clinicId;\r\n\r\n  useEffect(() => {\r\n    if (loading || !clinicId) return;\r\n    setError(null);\r\n\r\n    const unsub1 = subscribePendingPrescriptions(\r\n      clinicId,\r\n      (items) => setPrescriptions(items),\r\n      (err) => setError(err?.message ?? String(err))\r\n    );\r\n\r\n    const unsub2 = subscribeDrugs(\r\n      clinicId,\r\n      (items) => setDrugs(items),\r\n      (err) => setError(err?.message ?? String(err))\r\n    );\r\n\r\n    return () => {\r\n      try { unsub1?.(); } catch(_) {}\r\n      try { unsub2?.(); } catch(_) {}\r\n    };\r\n  }, [loading, clinicId]);\r\n\r\n  // AUTH GUARD\r\n  if (loading) return <div className=\"p-10\">Loading...</div>;\r\n  if (!user) return <div className=\"p-10\">Sign in required</div>;\r\n  if (!claims?.clinicId || !['pharmacist', 'admin'].includes(claims.role)) {\r\n    return <div className=\"p-10\">Access denied — pharmacist role required.</div>;\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-[calc(100vh-56px)] bg-slate-50\">\r\n      <div className=\"max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-6\">\r\n        <aside className=\"lg:col-span-3\">\r\n          <PharmacySidebar\r\n            prescriptions={prescriptions}\r\n            selectedId={selectedPrescription?.id}\r\n            onSelect={(p) => setSelectedPrescription(p)}\r\n            selectedPrescription={selectedPrescription}  // <-- pass selected preview\r\n          />\r\n        </aside>\r\n\r\n        <main className=\"lg:col-span-6\">\r\n          <PharmacyCenter\r\n            clinicId={clinicId}\r\n            drugs={drugs}\r\n            prescription={selectedPrescription}\r\n            pharmacistEmail={user.email}\r\n          />\r\n        </main>\r\n\r\n        <aside className=\"lg:col-span-3\">\r\n          <div className=\"sticky top-6\">\r\n            <PharmacyQuickActions clinicId={clinicId} />\r\n          </div>\r\n        </aside>\r\n      </div>\r\n\r\n      {error && (\r\n        <div className=\"max-w-7xl mx-auto p-4\">\r\n          <div className=\"bg-red-50 text-red-700 border border-red-200 p-3 rounded\">\r\n            {error}\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"AAAA,uBAAuB;;;;;;AAGvB;AACA;AACA;AACA;AACA;AACA;;;AAPA;;;;;;;AASe,SAAS;;IACtB,MAAM,EAAE,IAAI,EAAE,MAAM,EAAE,OAAO,EAAE,GAAG,IAAA,2JAAO;IACzC,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,4LAAQ,EAAC,EAAE;IACrD,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,4LAAQ,EAAC,EAAE;IACrC,MAAM,CAAC,sBAAsB,wBAAwB,GAAG,IAAA,4LAAQ,EAAC;IACjE,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,4LAAQ,EAAC;IAEnC,MAAM,WAAW,QAAQ;IAEzB,IAAA,6LAAS;kCAAC;YACR,IAAI,WAAW,CAAC,UAAU;YAC1B,SAAS;YAET,MAAM,SAAS,IAAA,6KAA6B,EAC1C;iDACA,CAAC,QAAU,iBAAiB;;iDAC5B,CAAC,MAAQ,SAAS,KAAK,WAAW,OAAO;;YAG3C,MAAM,SAAS,IAAA,8JAAc,EAC3B;iDACA,CAAC,QAAU,SAAS;;iDACpB,CAAC,MAAQ,SAAS,KAAK,WAAW,OAAO;;YAG3C;0CAAO;oBACL,IAAI;wBAAE;oBAAY,EAAE,OAAM,GAAG,CAAC;oBAC9B,IAAI;wBAAE;oBAAY,EAAE,OAAM,GAAG,CAAC;gBAChC;;QACF;iCAAG;QAAC;QAAS;KAAS;IAEtB,aAAa;IACb,IAAI,SAAS,qBAAO,gNAAC;QAAI,WAAU;kBAAO;;;;;;IAC1C,IAAI,CAAC,MAAM,qBAAO,gNAAC;QAAI,WAAU;kBAAO;;;;;;IACxC,IAAI,CAAC,QAAQ,YAAY,CAAC;QAAC;QAAc;KAAQ,CAAC,QAAQ,CAAC,OAAO,IAAI,GAAG;QACvE,qBAAO,gNAAC;YAAI,WAAU;sBAAO;;;;;;IAC/B;IAEA,qBACE,gNAAC;QAAI,WAAU;;0BACb,gNAAC;gBAAI,WAAU;;kCACb,gNAAC;wBAAM,WAAU;kCACf,cAAA,gNAAC,8JAAe;4BACd,eAAe;4BACf,YAAY,sBAAsB;4BAClC,UAAU,CAAC,IAAM,wBAAwB;4BACzC,sBAAsB;;;;;;;;;;;kCAI1B,gNAAC;wBAAK,WAAU;kCACd,cAAA,gNAAC,6JAAc;4BACb,UAAU;4BACV,OAAO;4BACP,cAAc;4BACd,iBAAiB,KAAK,KAAK;;;;;;;;;;;kCAI/B,gNAAC;wBAAM,WAAU;kCACf,cAAA,gNAAC;4BAAI,WAAU;sCACb,cAAA,gNAAC,mKAAoB;gCAAC,UAAU;;;;;;;;;;;;;;;;;;;;;;YAKrC,uBACC,gNAAC;gBAAI,WAAU;0BACb,cAAA,gNAAC;oBAAI,WAAU;8BACZ;;;;;;;;;;;;;;;;;AAMb;GA3EwB;;QACY,2JAAO;;;KADnB"}}]
}