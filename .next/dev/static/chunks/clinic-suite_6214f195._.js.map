{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/Education/WebDev%20with%20AI/Projects/clinic-suite/utils/idHelpers.js"],"sourcesContent":["// utils/idHelpers.js\nexport function formatDateToId(date = new Date()){\n  const d = (date instanceof Date) ? date : new Date(date);\n  const pad = (n) => String(n).padStart(2, '0');\n  const YYYY = d.getFullYear();\n  const MM = pad(d.getMonth() + 1);\n  const DD = pad(d.getDate());\n  const hh = pad(d.getHours());\n  const mm = pad(d.getMinutes());\n  const ss = pad(d.getSeconds());\n  return `${YYYY}${MM}${DD}${hh}${mm}${ss}`;\n}\n"],"names":[],"mappings":"AAAA,qBAAqB;;;;;AACd,SAAS,eAAe,OAAO,IAAI,MAAM;IAC9C,MAAM,IAAI,AAAC,gBAAgB,OAAQ,OAAO,IAAI,KAAK;IACnD,MAAM,MAAM,CAAC,IAAM,OAAO,GAAG,QAAQ,CAAC,GAAG;IACzC,MAAM,OAAO,EAAE,WAAW;IAC1B,MAAM,KAAK,IAAI,EAAE,QAAQ,KAAK;IAC9B,MAAM,KAAK,IAAI,EAAE,OAAO;IACxB,MAAM,KAAK,IAAI,EAAE,QAAQ;IACzB,MAAM,KAAK,IAAI,EAAE,UAAU;IAC3B,MAAM,KAAK,IAAI,EAAE,UAAU;IAC3B,OAAO,GAAG,OAAO,KAAK,KAAK,KAAK,KAAK,IAAI;AAC3C"}},
    {"offset": {"line": 27, "column": 0}, "map": {"version":3,"sources":["file:///D:/Education/WebDev%20with%20AI/Projects/clinic-suite/lib/firestoreClient.js"],"sourcesContent":["// lib/firestoreClient.js\r\n// Consolidated Firestore client helpers for Clinic Suite\r\nimport { db } from './firebase';\r\nimport {\r\n  collection,\r\n  doc,\r\n  setDoc,\r\n  getDocs,\r\n  query,\r\n  orderBy,\r\n  onSnapshot,\r\n  where,\r\n  updateDoc,\r\n  deleteDoc,\r\n  getDoc,\r\n  addDoc,\r\n  runTransaction\r\n} from 'firebase/firestore';\r\nimport { formatDateToId } from '../utils/idHelpers';\r\n\r\n/* ============================\r\n   Collection reference helpers\r\n   ============================ */\r\nfunction patientsCollectionRef(clinicId) {\r\n  return collection(db, 'clinics', clinicId, 'patients');\r\n}\r\nfunction appointmentsCollectionRef(clinicId) {\r\n  return collection(db, 'clinics', clinicId, 'appointments');\r\n}\r\nfunction drugsCollectionRef(clinicId) {\r\n  return collection(db, 'clinics', clinicId, 'drugs');\r\n}\r\nfunction consultationsCollectionRef(clinicId) {\r\n  return collection(db, 'clinics', clinicId, 'consultations');\r\n}\r\nfunction prescriptionsCollectionRef(clinicId) {\r\n  return collection(db, 'clinics', clinicId, 'prescriptions');\r\n}\r\nfunction invoicesCollectionRef(clinicId) {\r\n  return collection(db, 'clinics', clinicId, 'invoices');\r\n}\r\n\r\n/* ============================\r\n   Patients\r\n   ============================ */\r\n\r\n/* Patients: subscribe live */\r\nexport function subscribePatients(clinicId, callback, onError) {\r\n  if (!clinicId) {\r\n    if (onError) onError(new Error('clinicId required'));\r\n    return () => {};\r\n  }\r\n  const q = query(patientsCollectionRef(clinicId), orderBy('createdAt', 'desc'));\r\n  const unsub = onSnapshot(q, (snap) => {\r\n    const items = snap.docs.map((d) => ({ id: d.id, ...d.data() }));\r\n    callback(items);\r\n  }, onError);\r\n  return unsub;\r\n}\r\n\r\n/* fetch once */\r\nexport async function fetchPatientsOnce(clinicId) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const q = query(patientsCollectionRef(clinicId), orderBy('createdAt', 'desc'));\r\n  const snap = await getDocs(q);\r\n  return snap.docs.map((d) => ({ id: d.id, ...d.data() }));\r\n}\r\n\r\n/* create or update patient (patient.nic used as doc id) */\r\nexport async function createOrUpdatePatient(clinicId, patient, createdByEmail = null) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!patient || !patient.nic) throw new Error('patient.nic (NIC) required');\r\n\r\n  const patientId = String(patient.nic).trim();\r\n  const ref = doc(db, 'clinics', clinicId, 'patients', patientId);\r\n\r\n  const now = new Date();\r\n  const payload = {\r\n    ...patient,\r\n    nic: patientId,\r\n    updatedAt: now.toISOString(),\r\n    createdAt: patient.createdAt ?? now.toISOString(),\r\n    createdBy: patient.createdBy ?? createdByEmail ?? null\r\n  };\r\n  await setDoc(ref, payload, { merge: true });\r\n  return { id: patientId, ...payload };\r\n}\r\n\r\n/* get single patient */\r\nexport async function getPatient(clinicId, patientNic) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const ref = doc(db, 'clinics', clinicId, 'patients', String(patientNic));\r\n  const snap = await getDoc(ref);\r\n  if (!snap.exists()) return null;\r\n  return { id: snap.id, ...snap.data() };\r\n}\r\n\r\n/* update patient fields */\r\nexport async function updatePatient(clinicId, patientNic, data) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const ref = doc(db, 'clinics', clinicId, 'patients', String(patientNic));\r\n  await updateDoc(ref, { ...data, updatedAt: new Date().toISOString() });\r\n  const snap = await getDoc(ref);\r\n  return { id: snap.id, ...snap.data() };\r\n}\r\n\r\n/* ============================\r\n   Appointments\r\n   ============================ */\r\n\r\n/* Appointments: create using scheduledAt -> YYYYMMDDHHMMSS id */\r\nexport async function createAppointment(clinicId, { patientNic, scheduledAtISO, receptionistEmail = null, notes = '', status = 'confirmed' }) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!patientNic) throw new Error('patientNic required');\r\n\r\n  const scheduledDate = (scheduledAtISO instanceof Date) ? scheduledAtISO : new Date(scheduledAtISO);\r\n  if (Number.isNaN(scheduledDate.getTime())) throw new Error('Invalid scheduledAt value');\r\n\r\n  const appointmentId = formatDateToId(scheduledDate);\r\n  const ref = doc(db, 'clinics', clinicId, 'appointments', appointmentId);\r\n\r\n  const payload = {\r\n    patientNic: String(patientNic).trim(),\r\n    scheduledAt: scheduledDate.toISOString(),\r\n    status,\r\n    receptionistEmail,\r\n    notes,\r\n    createdAt: new Date().toISOString()\r\n  };\r\n\r\n  await setDoc(ref, payload, { merge: false });\r\n  return { id: appointmentId, ...payload };\r\n}\r\n\r\n/* fetch appointments for a patient (once) — client-side sort */\r\nexport async function fetchAppointmentsForPatient(clinicId, patientNic) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const coll = appointmentsCollectionRef(clinicId);\r\n  const q = query(coll, where('patientNic', '==', String(patientNic)));\r\n  const snap = await getDocs(q);\r\n  const items = snap.docs.map((d) => ({ id: d.id, ...d.data() }));\r\n  items.sort((a, b) => (b.scheduledAt || '').localeCompare(a.scheduledAt || ''));\r\n  return items;\r\n}\r\n\r\n/* subscribe appointments for a patient (live) — client-side sort */\r\nexport function subscribeAppointmentsForPatient(clinicId, patientNic, callback, onError) {\r\n  if (!clinicId) {\r\n    if (onError) onError(new Error('clinicId required'));\r\n    return () => {};\r\n  }\r\n  const coll = appointmentsCollectionRef(clinicId);\r\n  const q = query(coll, where('patientNic', '==', String(patientNic)));\r\n  const unsub = onSnapshot(q, (snap) => {\r\n    const items = snap.docs.map((d) => ({ id: d.id, ...d.data() }));\r\n    items.sort((a, b) => (b.scheduledAt || '').localeCompare(a.scheduledAt || ''));\r\n    callback(items);\r\n  }, (err) => {\r\n    console.error('subscribeAppointmentsForPatient error', err);\r\n    if (onError) onError(err);\r\n  });\r\n  return unsub;\r\n}\r\n\r\n/* update appointment (partial) */\r\nexport async function updateAppointment(clinicId, appointmentId, data) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const ref = doc(db, 'clinics', clinicId, 'appointments', String(appointmentId));\r\n  await updateDoc(ref, { ...data, updatedAt: new Date().toISOString() });\r\n  const snap = await getDoc(ref);\r\n  return { id: snap.id, ...snap.data() };\r\n}\r\n\r\n/* cancel appointment -> status = 'cancelled' */\r\nexport async function cancelAppointment(clinicId, appointmentId, cancelledByEmail = null) {\r\n  return updateAppointment(clinicId, appointmentId, { status: 'cancelled', cancelledBy: cancelledByEmail, cancelledAt: new Date().toISOString() });\r\n}\r\n\r\n/* delete appointment (if needed) */\r\nexport async function deleteAppointment(clinicId, appointmentId) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const ref = doc(db, 'clinics', clinicId, 'appointments', String(appointmentId));\r\n  await deleteDoc(ref);\r\n  return true;\r\n}\r\n\r\n/* ============================\r\n   Date-based appointment helpers\r\n   ============================ */\r\n\r\n/**\r\n * Fetch appointments for a specific date (ISO date string or Date object)\r\n * Returns appointments ordered by scheduledAt ascending.\r\n */\r\nexport async function fetchAppointmentsByDate(clinicId, date) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const d = (date instanceof Date) ? date : new Date(date);\r\n  const start = new Date(d); start.setHours(0,0,0,0);\r\n  const end = new Date(d); end.setHours(23,59,59,999);\r\n\r\n  const coll = appointmentsCollectionRef(clinicId);\r\n  const q = query(coll, where('scheduledAt', '>=', start.toISOString()), where('scheduledAt', '<=', end.toISOString()));\r\n  const snap = await getDocs(q);\r\n  const items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));\r\n  items.sort((a,b) => (a.scheduledAt || '').localeCompare(b.scheduledAt || ''));\r\n  return items;\r\n}\r\n\r\n/**\r\n * Subscribe to appointments for a specific date (real-time)\r\n * callback(items) on update\r\n */\r\nexport function subscribeAppointmentsByDate(clinicId, date, callback, onError) {\r\n  if (!clinicId) {\r\n    if (onError) onError(new Error('clinicId required'));\r\n    return () => {};\r\n  }\r\n  const d = (date instanceof Date) ? date : new Date(date);\r\n  const start = new Date(d); start.setHours(0,0,0,0);\r\n  const end = new Date(d); end.setHours(23,59,59,999);\r\n\r\n  const coll = appointmentsCollectionRef(clinicId);\r\n  const q = query(coll, where('scheduledAt', '>=', start.toISOString()), where('scheduledAt', '<=', end.toISOString()));\r\n  const unsub = onSnapshot(q, (snap) => {\r\n    const items = snap.docs.map(dd => ({ id: dd.id, ...dd.data() }));\r\n    items.sort((a,b) => (a.scheduledAt || '').localeCompare(b.scheduledAt || ''));\r\n    callback(items);\r\n  }, (err) => {\r\n    console.error('subscribeAppointmentsByDate error', err);\r\n    if (onError) onError(err);\r\n  });\r\n  return unsub;\r\n}\r\n\r\n/* ============================\r\n   Consultations\r\n   ============================ */\r\n\r\n/**\r\n * Create consultation document.\r\n * ID format: YYYYMMDDHHMMSS-<NIC>\r\n */\r\nexport async function createConsultation(clinicId, {\r\n  patientNic,\r\n  appointmentId = null,\r\n  doctorEmail = null,\r\n  presentComplaint = '',\r\n  examFindings = '',\r\n  differentialDiagnosis = '',\r\n  investigations = '',\r\n  management = ''\r\n} = {}) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!patientNic) throw new Error('patientNic required');\r\n\r\n  const now = new Date();\r\n  const id = formatDateToId(now) + '-' + String(patientNic);\r\n  const ref = doc(db, 'clinics', clinicId, 'consultations', id);\r\n\r\n  const docData = {\r\n    patientNic: String(patientNic),\r\n    appointmentId: appointmentId ?? null,\r\n    doctorEmail: doctorEmail ?? null,\r\n    presentComplaint,\r\n    examFindings,\r\n    differentialDiagnosis,\r\n    investigations,\r\n    management,\r\n    createdAt: now.toISOString(),\r\n    updatedAt: now.toISOString()\r\n  };\r\n\r\n  await setDoc(ref, docData, { merge: false });\r\n  return { id, ...docData };\r\n}\r\n\r\n/**\r\n * Fetch consultations for a patient (latest first)\r\n */\r\nexport async function fetchConsultationsForPatient(clinicId, patientNic) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!patientNic) throw new Error('patientNic required');\r\n\r\n  const coll = consultationsCollectionRef(clinicId);\r\n  const q = query(coll, where('patientNic', '==', String(patientNic)));\r\n  const snap = await getDocs(q);\r\n  const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n  items.sort((a,b) => (b.createdAt || '').localeCompare(a.createdAt || ''));\r\n  return items;\r\n}\r\n\r\n/**\r\n * Subscribe consultations for a patient (real-time)\r\n */\r\nexport function subscribeConsultationsForPatient(clinicId, patientNic, callback, onError) {\r\n  if (!clinicId) {\r\n    if (onError) onError(new Error('clinicId required'));\r\n    return () => {};\r\n  }\r\n  const coll = consultationsCollectionRef(clinicId);\r\n  const q = query(coll, where('patientNic', '==', String(patientNic)));\r\n  const unsub = onSnapshot(q, (snap) => {\r\n    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n    items.sort((a,b) => (b.createdAt || '').localeCompare(a.createdAt || ''));\r\n    callback(items);\r\n  }, (err) => {\r\n    console.error('subscribeConsultationsForPatient error', err);\r\n    if (onError) onError(err);\r\n  });\r\n  return unsub;\r\n}\r\n\r\n/* ============================\r\n   Prescriptions\r\n   ============================ */\r\n\r\n/**\r\n * Create prescription document (doctor creates from consultation)\r\n * id format: YYYYMMDDHHMMSS-<NIC>\r\n * Stored under clinics/{clinicId}/prescriptions/{prescId}\r\n */\r\nexport async function createPrescription(clinicId, { consultationId = null, patientNic, doctorEmail = null, rawManagement = '', items = [] } = {}) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!patientNic) throw new Error('patientNic required');\r\n\r\n  const now = new Date();\r\n  const prescId = formatDateToId(now) + '-' + String(patientNic);\r\n  const ref = doc(db, 'clinics', clinicId, 'prescriptions', prescId);\r\n\r\n  // compute subtotal if items provided\r\n  let subtotal = 0;\r\n  const normalizedItems = (Array.isArray(items) ? items : []).map(it => {\r\n    const unitPrice = Number(it.unitPrice || 0) || 0;\r\n    const qty = Number(it.qty || 0) || 0;\r\n    const lineTotal = unitPrice * qty;\r\n    subtotal += lineTotal;\r\n    return {\r\n      drugId: it.drugId ?? null,\r\n      drugName: it.drugName ?? (it.name ?? ''),\r\n      dose: it.dose ?? '',\r\n      qty,\r\n      unitPrice,\r\n      lineTotal,\r\n      raw: it.raw ?? null\r\n    };\r\n  });\r\n\r\n  const docData = {\r\n    consultationId,\r\n    patientNic: String(patientNic),\r\n    doctorEmail: doctorEmail ?? null,\r\n    rawManagement: rawManagement ?? '',\r\n    items: normalizedItems,\r\n    subtotal,\r\n    tax: 0,\r\n    total: subtotal,\r\n    status: 'pending',\r\n    createdAt: now.toISOString()\r\n  };\r\n\r\n  await setDoc(ref, docData, { merge: false });\r\n  return { id: prescId, ...docData };\r\n}\r\n\r\n/**\r\n * Subscribe pending prescriptions (pharmacist)\r\n */\r\nexport function subscribePendingPrescriptions(clinicId, callback, onError) {\r\n  if (!clinicId) {\r\n    if (onError) onError(new Error('clinicId required'));\r\n    return () => {};\r\n  }\r\n  const coll = prescriptionsCollectionRef(clinicId);\r\n  const q = query(coll, where('status', '==', 'pending'), orderBy('createdAt', 'asc'));\r\n  const unsub = onSnapshot(q, (snap) => {\r\n    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n    callback(items);\r\n  }, (err) => {\r\n    console.error('subscribePendingPrescriptions error', err);\r\n    if (onError) onError(err);\r\n  });\r\n  return unsub;\r\n}\r\n\r\n/* ============================\r\n   Drugs (inventory)\r\n   ============================ */\r\n\r\n/* Subscribe / fetch drugs list */\r\nexport function subscribeDrugs(clinicId, callback, onError) {\r\n  if (!clinicId) {\r\n    if (onError) onError(new Error('clinicId required'));\r\n    return () => {};\r\n  }\r\n  const coll = drugsCollectionRef(clinicId);\r\n  const q = query(coll, orderBy('name', 'asc'));\r\n  const unsub = onSnapshot(q, (snap) => {\r\n    const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n    callback(items);\r\n  }, onError);\r\n  return unsub;\r\n}\r\n\r\nexport async function fetchDrugsOnce(clinicId) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const coll = drugsCollectionRef(clinicId);\r\n  const q = query(coll, orderBy('name', 'asc'));\r\n  const snap = await getDocs(q);\r\n  return snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n}\r\n\r\nexport async function createOrUpdateDrug(clinicId, drugIdOrName, { name, dose, qtyAvailable = 0, pricePerUnit = 0, updatedBy = null } = {}) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  const id = String(drugIdOrName).trim();\r\n  const ref = doc(db, 'clinics', clinicId, 'drugs', id);\r\n  const payload = {\r\n    name: name ?? id,\r\n    dose: dose ?? '',\r\n    qtyAvailable: Number(qtyAvailable) || 0,\r\n    pricePerUnit: Number(pricePerUnit) || 0,\r\n    updatedAt: new Date().toISOString(),\r\n    updatedBy: updatedBy ?? null\r\n  };\r\n  await setDoc(ref, payload, { merge: true });\r\n  return { id, ...payload };\r\n}\r\n\r\n/* ============================\r\n   Stock transactions: decrement / increment\r\n   ============================ */\r\n\r\n/**\r\n * Decrement drug stock atomically using a transaction.\r\n * Ensures stock never goes negative.\r\n *\r\n * Returns the new qtyAvailable after decrement.\r\n */\r\nexport async function decrementDrugStock(clinicId, drugId, decQty = 1) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!drugId) throw new Error('drugId required');\r\n  decQty = Number(decQty) || 0;\r\n  if (decQty <= 0) throw new Error('decQty must be > 0');\r\n\r\n  const drugRef = doc(db, 'clinics', clinicId, 'drugs', String(drugId));\r\n\r\n  const result = await runTransaction(db, async (tx) => {\r\n    const snap = await tx.get(drugRef);\r\n    if (!snap.exists()) throw new Error('Drug not found');\r\n    const data = snap.data();\r\n    const current = Number(data.qtyAvailable || 0);\r\n    if (current < decQty) throw new Error(`Insufficient stock for ${data.name || drugId} (need ${decQty}, have ${current})`);\r\n    const newQty = current - decQty;\r\n    tx.update(drugRef, { qtyAvailable: newQty, updatedAt: new Date().toISOString() });\r\n    return newQty;\r\n  });\r\n\r\n  return result; // number\r\n}\r\n\r\n/**\r\n * Increment drug stock atomically using a transaction.\r\n * Use when removing items from cart / restocking.\r\n *\r\n * @returns {number} newQty\r\n */\r\nexport async function incrementDrugStock(clinicId, drugId, incQty = 1) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!drugId) throw new Error('drugId required');\r\n  incQty = Number(incQty) || 0;\r\n  if (incQty <= 0) throw new Error('incQty must be > 0');\r\n\r\n  const drugRef = doc(db, 'clinics', clinicId, 'drugs', String(drugId));\r\n\r\n  const result = await runTransaction(db, async (tx) => {\r\n    const snap = await tx.get(drugRef);\r\n    if (!snap.exists()) throw new Error('Drug not found');\r\n    const data = snap.data();\r\n    const current = Number(data.qtyAvailable || 0);\r\n    const newQty = current + incQty;\r\n    tx.update(drugRef, { qtyAvailable: newQty, updatedAt: new Date().toISOString() });\r\n    return newQty;\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/* ============================\r\n   Issue prescription transaction\r\n   ============================ */\r\n\r\n/**\r\n * issuePrescriptionTransaction\r\n * - clinicId\r\n * - prescriptionId\r\n * - pharmacistEmail\r\n * - items: [{ drugId, qty }]  // items to issue; caller should provide qty and drugId\r\n *\r\n * Behavior (atomic transaction):\r\n *  - verify prescription exists and is pending\r\n *  - load each drug doc and ensure qtyAvailable >= qty requested\r\n *  - decrement qtyAvailable for each drug\r\n *  - create invoice doc (id format formatDateToId + -patientNic)\r\n *  - update prescription status -> 'issued', set issuedAt, issuedBy, invoiceId\r\n *  - return invoice summary\r\n */\r\nexport async function issuePrescriptionTransaction(clinicId, prescriptionId, pharmacistEmail, items = []) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!prescriptionId) throw new Error('prescriptionId required');\r\n  if (!Array.isArray(items) || items.length === 0) throw new Error('items required');\r\n\r\n  const prescRef = doc(db, 'clinics', clinicId, 'prescriptions', prescriptionId);\r\n\r\n  const result = await runTransaction(db, async (tx) => {\r\n    const prescSnap = await tx.get(prescRef);\r\n    if (!prescSnap.exists()) throw new Error('Prescription not found');\r\n    const presc = prescSnap.data();\r\n\r\n    if (presc.status === 'issued') throw new Error('Prescription already issued');\r\n\r\n    // Prepare drug refs and read them\r\n    const drugRefs = items.map(i => doc(db, 'clinics', clinicId, 'drugs', String(i.drugId)));\r\n    const drugSnaps = [];\r\n    for (const r of drugRefs) {\r\n      const s = await tx.get(r);\r\n      drugSnaps.push(s);\r\n    }\r\n\r\n    // Check availability\r\n    for (let i = 0; i < items.length; i++) {\r\n      const it = items[i];\r\n      const snap = drugSnaps[i];\r\n      if (!snap.exists()) throw new Error(`Drug not found: ${it.drugId}`);\r\n      const d = snap.data();\r\n      const available = Number(d.qtyAvailable || 0);\r\n      const needed = Number(it.qty || 0);\r\n      if (needed <= 0) throw new Error(`Invalid qty for ${it.drugId}`);\r\n      if (available < needed) throw new Error(`Insufficient stock for ${d.name} (need ${needed}, have ${available})`);\r\n    }\r\n\r\n    // Compute line items and totals\r\n    const lineItems = [];\r\n    let subtotal = 0;\r\n    for (let i = 0; i < items.length; i++) {\r\n      const it = items[i];\r\n      const snap = drugSnaps[i];\r\n      const d = snap.data();\r\n      const unitPrice = Number(d.pricePerUnit || 0);\r\n      const qty = Number(it.qty || 0);\r\n      const lineTotal = unitPrice * qty;\r\n      subtotal += lineTotal;\r\n      lineItems.push({\r\n        drugId: String(it.drugId),\r\n        drugName: d.name,\r\n        dose: d.dose || '',\r\n        qty,\r\n        unitPrice,\r\n        lineTotal\r\n      });\r\n    }\r\n\r\n    // Create invoice id\r\n    const now = new Date();\r\n    const invoiceId = formatDateToId(now) + '-' + String(presc.patientNic || 'unknown');\r\n\r\n    const invRef = doc(db, 'clinics', clinicId, 'invoices', invoiceId);\r\n\r\n    const invoiceDoc = {\r\n      prescriptionId,\r\n      patientNic: presc.patientNic,\r\n      pharmacistEmail,\r\n      createdAt: now.toISOString(),\r\n      items: lineItems,\r\n      subtotal,\r\n      tax: 0,\r\n      total: subtotal,\r\n      status: 'unpaid'\r\n    };\r\n\r\n    // Decrement stocks\r\n    for (let i = 0; i < items.length; i++) {\r\n      const it = items[i];\r\n      const r = drugRefs[i];\r\n      const snap = drugSnaps[i];\r\n      const current = Number(snap.data().qtyAvailable || 0);\r\n      const newQty = current - Number(it.qty || 0);\r\n      tx.update(r, { qtyAvailable: newQty, updatedAt: new Date().toISOString() });\r\n    }\r\n\r\n    // Create invoice\r\n    tx.set(invRef, invoiceDoc);\r\n\r\n    // Update prescription to issued\r\n    tx.update(prescRef, {\r\n      status: 'issued',\r\n      issuedAt: now.toISOString(),\r\n      issuedBy: pharmacistEmail,\r\n      invoiceId\r\n    });\r\n\r\n    // Optionally link invoiceId into consultation doc\r\n    if (presc.consultationId) {\r\n      const consultRef = doc(db, 'clinics', clinicId, 'consultations', presc.consultationId);\r\n      const consultSnap = await tx.get(consultRef);\r\n      if (consultSnap.exists()) {\r\n        tx.update(consultRef, { invoiceId });\r\n      }\r\n    }\r\n\r\n    return {\r\n      invoiceId,\r\n      invoice: invoiceDoc\r\n    };\r\n  });\r\n\r\n  return result;\r\n}\r\n\r\n/* ============================\r\n   Fetch helpers: one-off / subscription\r\n   ============================ */\r\n\r\n/* -- already have subscribePatients, subscribeDrugs, subscribePendingPrescriptions, subscribeConsultationsForPatient, etc. -- */\r\n\r\n/* Provide fetch functions for invoices if needed */\r\nexport async function fetchInvoicesForPatient(clinicId, patientNic) {\r\n  if (!clinicId) throw new Error('clinicId required');\r\n  if (!patientNic) throw new Error('patientNic required');\r\n  const coll = invoicesCollectionRef(clinicId);\r\n  const q = query(coll, where('patientNic', '==', String(patientNic)));\r\n  const snap = await getDocs(q);\r\n  return snap.docs.map(d => ({ id: d.id, ...d.data() }));\r\n}\r\n\r\n/* ============================\r\n   Exports (already named exports above)\r\n   ============================ */\r\n\r\n// Note: all functions are exported as named exports above.\r\n// No default export.\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 629, "column": 0}, "map": {"version":3,"sources":["file:///D:/Education/WebDev%20with%20AI/Projects/clinic-suite/components/ConsultationSidebar.js"],"sourcesContent":["// components/ConsultationSidebar.js\r\n'use client';\r\n\r\nimport React, { useEffect, useMemo, useState } from 'react';\r\nimport { getPatient } from '../lib/firestoreClient';\r\n\r\n/**\r\n * ConsultationSidebar\r\n *\r\n * Props:\r\n * - clinicId: string\r\n * - date: \"YYYY-MM-DD\" (string)\r\n * - onChangeDate: function(newDateString)\r\n * - appointments: array of appointment objects (each must have id, patientNic, scheduledAt, status)\r\n * - selectedAppointmentId: string or null\r\n * - onSelect: function(appointment)\r\n */\r\nexport default function ConsultationSidebar({\r\n  clinicId,\r\n  date = new Date().toISOString().slice(0, 10),\r\n  onChangeDate = () => {},\r\n  appointments = [],\r\n  selectedAppointmentId = null,\r\n  onSelect = () => {}\r\n}) {\r\n  const [patientMap, setPatientMap] = useState({});\r\n  const [loadingMap, setLoadingMap] = useState(false);\r\n  const [error, setError] = useState(null);\r\n\r\n  // compute unique NICs present in appointments\r\n  const uniqueNics = useMemo(() => {\r\n    const s = new Set();\r\n    for (const a of appointments || []) {\r\n      if (a && a.patientNic) s.add(String(a.patientNic));\r\n    }\r\n    return Array.from(s);\r\n  }, [appointments]);\r\n\r\n  // fetch patient docs for those NICs (batch)\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    if (!clinicId || uniqueNics.length === 0) {\r\n      setPatientMap({});\r\n      return;\r\n    }\r\n\r\n    setLoadingMap(true);\r\n    setError(null);\r\n\r\n    (async () => {\r\n      try {\r\n        const map = {};\r\n        await Promise.all(\r\n          uniqueNics.map(async (nic) => {\r\n            try {\r\n              const p = await getPatient(clinicId, nic);\r\n              map[nic] = p ?? null;\r\n            } catch (err) {\r\n              map[nic] = null;\r\n              console.error('getPatient error', nic, err);\r\n            }\r\n          })\r\n        );\r\n\r\n        if (!mounted) return;\r\n        setPatientMap(map);\r\n      } catch (err) {\r\n        console.error('fetch patientMap failed', err);\r\n        if (mounted) setError(err?.message ?? String(err));\r\n      } finally {\r\n        if (mounted) setLoadingMap(false);\r\n      }\r\n    })();\r\n\r\n    return () => {\r\n      mounted = false;\r\n    };\r\n  }, [clinicId, uniqueNics.join('|')]);\r\n\r\n  function formatTime(iso) {\r\n    if (!iso) return '';\r\n    try {\r\n      const d = new Date(iso);\r\n      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\r\n    } catch {\r\n      return iso;\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Calendar block */}\r\n      <div className=\"rounded-xl bg-white p-4 shadow-sm\">\r\n        <div className=\"text-sm font-medium text-slate-800\">Calendar</div>\r\n        <div className=\"mt-3\">\r\n          <input\r\n            type=\"date\"\r\n            value={date}\r\n            onChange={(e) => onChangeDate(e.target.value)}\r\n            className=\"w-full p-2 border rounded\"\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Appointments block */}\r\n      <div className=\"bg-white rounded-xl border border-slate-100 shadow-sm p-4\">\r\n        <div className=\"flex items-center justify-between mb-3\">\r\n          <div className=\"text-sm font-medium text-slate-700\">Appointments for selected date</div>\r\n        </div>\r\n\r\n        {loadingMap && (\r\n          <div className=\"text-sm text-slate-500 py-4\">Loading patients...</div>\r\n        )}\r\n\r\n        {error && (\r\n          <div className=\"text-sm text-red-600 py-2\">Error: {String(error)}</div>\r\n        )}\r\n\r\n        <div className=\"space-y-2 max-h-[56vh] overflow-auto\">\r\n          {appointments.length === 0 && (\r\n            <div className=\"text-sm text-slate-400 p-3\">No appointments for this date.</div>\r\n          )}\r\n\r\n          {appointments.map((appt) => {\r\n            const nic = String(appt.patientNic ?? '').trim();\r\n            const patient = patientMap[nic];\r\n            const firstName =\r\n              patient?.firstName ||\r\n              patient?.givenName ||\r\n              (patient?.name?.split?.(' ')?.[0]) ||\r\n              '';\r\n            const lastName =\r\n              patient?.lastName ||\r\n              patient?.familyName ||\r\n              (patient?.name && patient.name.split(' ').slice(1).join(' ')) ||\r\n              '';\r\n            const gender =\r\n              (patient && patient.gender)\r\n                ? String(patient.gender)\r\n                : (patient && patient.sex)\r\n                ? String(patient.sex)\r\n                : '';\r\n            const titleLine =\r\n              (firstName || lastName || gender)\r\n                ? `${[firstName, lastName].filter(Boolean).join(' ')}${gender ? `, ${gender}` : ''}`\r\n                : nic;\r\n\r\n            const isSelected = selectedAppointmentId && selectedAppointmentId === appt.id;\r\n\r\n            return (\r\n              <button\r\n                key={appt.id}\r\n                onClick={() => onSelect(appt)}\r\n                className={`w-full text-left p-3 rounded-lg border ${isSelected ? 'border-indigo-200 bg-indigo-50' : 'border-transparent hover:border-slate-200'} `}\r\n              >\r\n                <div className=\"flex items-start justify-between\">\r\n                  <div>\r\n                    <div className=\"text-sm font-semibold text-slate-900\">\r\n                      {patient ? titleLine : nic}\r\n                    </div>\r\n                    <div className=\"text-xs text-slate-500 mt-0.5\">\r\n                      {nic} • {appt.status || 'confirmed'}\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"text-xs text-slate-500 ml-3\">\r\n                    {formatTime(appt.scheduledAt)}\r\n                  </div>\r\n                </div>\r\n              </button>\r\n            );\r\n          })}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 896, "column": 0}, "map": {"version":3,"sources":["file:///D:/Education/WebDev%20with%20AI/Projects/clinic-suite/components/NewConsultationForm.js"],"sourcesContent":["// components/NewConsultationForm.js\r\n'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { createConsultation } from '../lib/firestoreClient';\r\nimport { createPrescription } from '../lib/firestoreClient';\r\n\r\n/**\r\n * Props:\r\n *  - patient (object) - full patient object (id = NIC, firstName, lastName, dob, gender)\r\n *  - patientNic (string) optional (legacy) — patient.id is preferred\r\n *  - appointmentId (string) optional\r\n *  - clinicId (string) required for saving\r\n *  - doctorEmail (string) required for saving/printing\r\n *  - onSaved(createdConsultation) callback\r\n */\r\nexport default function NewConsultationForm({ patient = null, patientNic = null, appointmentId = null, clinicId, doctorEmail, onSaved = () => {} }) {\r\n  const resolvedNic = (patient && patient.id) || patientNic || '';\r\n  const [presentComplaint, setPresentComplaint] = useState('');\r\n  const [examFindings, setExamFindings] = useState('');\r\n  const [differentialDiagnosis, setDifferentialDiagnosis] = useState('');\r\n  const [investigations, setInvestigations] = useState('');\r\n  const [management, setManagement] = useState('');\r\n  const [saving, setSaving] = useState(false);\r\n  const [error, setError] = useState(null);\r\n\r\n  useEffect(() => {\r\n    // no-op\r\n  }, [patient]);\r\n\r\n  // Parse management free-text into structured drug items based on the user-specified syntax:\r\n  // <drug name><space><dosage><space><frequency><space>\"x\"<space><duration in number><space>\"days\"\r\n  // Frequencies allowed (case-insensitive): mane, nocte, daily, bd, tds, qds\r\n  function parseManagementLines(rawText) {\r\n    const lines = (rawText || '').split('\\n').map(l => l.trim()).filter(Boolean);\r\n    const items = [];\r\n    const re = /^(.+?)\\s+(\\S+)\\s+(mane|nocte|daily|bd|tds|qds)\\s+x\\s+(\\d+)\\s+days$/i;\r\n\r\n    for (const line of lines) {\r\n      const m = line.match(re);\r\n      if (!m) {\r\n        items.push({ raw: line });\r\n      } else {\r\n        const [, name, dose, freq, dur] = m;\r\n        items.push({\r\n          drugName: name.trim(),\r\n          dose: dose.trim(),\r\n          frequency: freq.toLowerCase(),\r\n          durationDays: Number(dur)\r\n        });\r\n      }\r\n    }\r\n    return items;\r\n  }\r\n\r\n  // Create printable HTML for prescription\r\n  function buildPrescriptionHtml({ clinicId, patientObj, doctorEmail, items, now }) {\r\n    const clinicName = clinicId || 'Clinic';\r\n    const patientName = `${patientObj.firstName || ''} ${patientObj.lastName || ''}`.trim() || '—';\r\n    const dob = patientObj.dob || '';\r\n    const ageStr = (() => {\r\n      if (!dob) return '—';\r\n      try {\r\n        const b = new Date(dob);\r\n        const diff = Date.now() - b.getTime();\r\n        const years = Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));\r\n        return `${years} y`;\r\n      } catch { return '—'; }\r\n    })();\r\n    const gender = patientObj.gender || '—';\r\n\r\n    const escaped = (s) => {\r\n      if (!s) return '';\r\n      return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('\"', '&quot;').replaceAll(\"'\", '&#039;');\r\n    };\r\n\r\n    return `<!doctype html>\r\n<html>\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <title>Prescription - ${escaped(patientName)}</title>\r\n  <style>\r\n    @page { size: A5; margin: 12mm; }\r\n    html,body { height: 100%; margin:0; padding:0; }\r\n    body { font-family: Arial, Helvetica, sans-serif; color: #111; font-size: 12px; padding: 6mm; box-sizing: border-box; }\r\n    .header { text-align: center; margin-bottom: 6px; }\r\n    .clinic { font-weight: 700; font-size: 14px; }\r\n    .meta { font-size: 11px; color: #333; margin-bottom: 8px; }\r\n    .section { margin-bottom: 8px; }\r\n    table { width: 100%; border-collapse: collapse; margin-top: 6px; }\r\n    th, td { border-bottom: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 11px; }\r\n    th { background: #fafafa; font-weight: 700; }\r\n    .footer { text-align: center; margin-top: 12px; font-size: 11px; }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"header\">\r\n    <div class=\"clinic\">${escaped(clinicName)}</div>\r\n    <div class=\"meta\">Prescription</div>\r\n  </div>\r\n\r\n  <div class=\"section\">\r\n    <div><strong>Patient:</strong> ${escaped(patientName)}</div>\r\n    <div><strong>NIC:</strong> ${escaped(patientObj.id || '')}</div>\r\n    <div><strong>Age/Gender:</strong> ${escaped(ageStr)} / ${escaped(gender)}</div>\r\n    <div><strong>Date:</strong> ${escaped(now.toLocaleString())}</div>\r\n  </div>\r\n\r\n  <div class=\"section\">\r\n    <table>\r\n      <thead>\r\n        <tr>\r\n          <th style=\"width:40%;\">Drug</th>\r\n          <th style=\"width:20%;\">Dose</th>\r\n          <th style=\"width:20%;\">Frequency</th>\r\n          <th style=\"width:20%;\">Duration</th>\r\n        </tr>\r\n      </thead>\r\n      <tbody>\r\n        ${items.map(i => {\r\n          if (i.raw) {\r\n            return `<tr><td colspan=\"4\">${escaped(i.raw)}</td></tr>`;\r\n          }\r\n          return `<tr>\r\n            <td>${escaped(i.drugName)}</td>\r\n            <td>${escaped(i.dose)}</td>\r\n            <td>${escaped(i.frequency)}</td>\r\n            <td>${escaped(String(i.durationDays))} days</td>\r\n          </tr>`;\r\n        }).join('')}\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n\r\n  <div class=\"footer\">Doctor: ${escaped(doctorEmail || '—')}</div>\r\n</body>\r\n</html>`;\r\n  }\r\n\r\n  // Print via hidden iframe to avoid popup blocks\r\n  function printPrescription() {\r\n    if (!management || !doctorEmail) {\r\n      alert('Cannot print — ensure management text and doctor email are present.');\r\n      return;\r\n    }\r\n\r\n    const patientObj = patient || { id: resolvedNic, firstName: '', lastName: '', dob: '', gender: '' };\r\n    const items = parseManagementLines(management);\r\n    const now = new Date();\r\n    const html = buildPrescriptionHtml({ clinicId, patientObj, doctorEmail, items, now });\r\n\r\n    try {\r\n      // create hidden iframe\r\n      const iframe = document.createElement('iframe');\r\n      iframe.style.position = 'fixed';\r\n      iframe.style.right = '0';\r\n      iframe.style.bottom = '0';\r\n      iframe.style.width = '0';\r\n      iframe.style.height = '0';\r\n      iframe.style.border = '0';\r\n      iframe.style.visibility = 'hidden';\r\n      document.body.appendChild(iframe);\r\n\r\n      const iframeDoc = iframe.contentWindow || iframe.contentDocument;\r\n      const doc = (iframeDoc.document) ? iframeDoc.document : iframeDoc;\r\n\r\n      doc.open();\r\n      doc.write(html);\r\n      doc.close();\r\n\r\n      // Some browsers need a short delay to render\r\n      const printAndCleanup = () => {\r\n        try {\r\n          // call print\r\n          iframe.contentWindow.focus();\r\n          // The print() must be directly triggered by user gesture to avoid blocking; since this function is called from click it's fine.\r\n          const printed = iframe.contentWindow.print();\r\n          // cleanup after small timeout (gives print dialog time to open)\r\n          setTimeout(() => {\r\n            try { document.body.removeChild(iframe); } catch (_) {}\r\n          }, 500);\r\n        } catch (err) {\r\n          try { document.body.removeChild(iframe); } catch (_) {}\r\n          console.error('Print failed', err);\r\n          alert('Printing failed. Please allow the browser to print or try saving as PDF from the print dialog.');\r\n        }\r\n      };\r\n\r\n      // If iframe content may take a moment to load resources, wait until ready\r\n      // but avoid long waits; do a short delay\r\n      setTimeout(printAndCleanup, 300);\r\n    } catch (err) {\r\n      console.error('printPrescription error', err);\r\n      alert('Unable to print. Please check browser settings.');\r\n    }\r\n  }\r\n\r\n  // Save consultation and also create a prescription doc\r\n  async function handleSave(e) {\r\n    e?.preventDefault();\r\n    setError(null);\r\n    if (!clinicId) {\r\n      setError('Missing clinic context (clinicId).');\r\n      return;\r\n    }\r\n    if (!resolvedNic) {\r\n      setError('Missing patient NIC.');\r\n      return;\r\n    }\r\n\r\n    setSaving(true);\r\n    try {\r\n      const consultPayload = {\r\n        patientNic: resolvedNic,\r\n        appointmentId: appointmentId ?? null,\r\n        doctorEmail: doctorEmail ?? null,\r\n        presentComplaint,\r\n        examFindings,\r\n        differentialDiagnosis,\r\n        investigations,\r\n        management\r\n      };\r\n\r\n      // create consultation\r\n      const created = await createConsultation(clinicId, consultPayload);\r\n\r\n      // create prescription right after consultation\r\n      const parsedItems = parseManagementLines(management).map(it => {\r\n        if (it.raw) return { raw: it.raw };\r\n        return {\r\n          drugName: it.drugName,\r\n          dose: it.dose,\r\n          frequency: it.frequency,\r\n          durationDays: it.durationDays\r\n        };\r\n      });\r\n\r\n      await createPrescription(clinicId, {\r\n        consultationId: created.id,\r\n        patientNic: resolvedNic,\r\n        doctorEmail: doctorEmail ?? null,\r\n        rawManagement: management || '',\r\n        items: parsedItems\r\n      });\r\n\r\n      onSaved && onSaved(created);\r\n      alert('Consultation saved and prescription created.');\r\n    } catch (err) {\r\n      console.error(err);\r\n      setError(err.message || String(err));\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <form onSubmit={handleSave} className=\"space-y-3\">\r\n      <div>\r\n        <label className=\"text-xs text-slate-500\">Presenting complaint</label>\r\n        <textarea value={presentComplaint} onChange={(e)=>setPresentComplaint(e.target.value)} className=\"w-full p-2 border rounded\" rows=\"3\" />\r\n      </div>\r\n\r\n      <div>\r\n        <label className=\"text-xs text-slate-500\">Examination findings</label>\r\n        <textarea value={examFindings} onChange={(e)=>setExamFindings(e.target.value)} className=\"w-full p-2 border rounded\" rows=\"3\" />\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\r\n        <div>\r\n          <label className=\"text-xs text-slate-500\">Differential diagnosis</label>\r\n          <textarea value={differentialDiagnosis} onChange={(e)=>setDifferentialDiagnosis(e.target.value)} className=\"w-full p-2 border rounded\" rows=\"2\" />\r\n        </div>\r\n        <div>\r\n          <label className=\"text-xs text-slate-500\">Investigations</label>\r\n          <textarea value={investigations} onChange={(e)=>setInvestigations(e.target.value)} className=\"w-full p-2 border rounded\" rows=\"2\" />\r\n        </div>\r\n      </div>\r\n\r\n      <div>\r\n        <label className=\"text-xs text-slate-500\">Management (one drug per line) <span className=\"text-xs text-slate-400\">(format: &lt;drug&gt; &lt;dose&gt; &lt;frequency&gt; x &lt;days&gt; — e.g. Paracetamol 500mg bd x 5 days)</span></label>\r\n        <textarea value={management} onChange={(e)=>setManagement(e.target.value)} className=\"w-full p-2 border rounded\" rows=\"5\" placeholder={`Paracetamol 500mg bd x 5 days\\nAmoxicillin 500mg tds x 7 days`} />\r\n      </div>\r\n\r\n      {error && <div className=\"text-sm text-red-600\">{error}</div>}\r\n\r\n      <div className=\"flex justify-between items-center\">\r\n        <div>\r\n          <button type=\"button\" onClick={printPrescription} disabled={!management || !doctorEmail} className=\"px-3 py-2 rounded-md border text-sm\">\r\n            Print Prescription\r\n          </button>\r\n        </div>\r\n        <div>\r\n          <button type=\"submit\" disabled={saving} className=\"px-3 py-2 rounded-md bg-indigo-600 text-white\">\r\n            {saving ? 'Saving...' : 'Save Consultation'}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </form>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1378, "column": 0}, "map": {"version":3,"sources":["file:///D:/Education/WebDev%20with%20AI/Projects/clinic-suite/components/ConsultationDetailCard.js"],"sourcesContent":["// components/ConsultationDetailCard.js\r\n'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport NewConsultationForm from './NewConsultationForm';\r\nimport { fetchConsultationsForPatient } from '../lib/firestoreClient';\r\n\r\nexport default function ConsultationDetailCard({ patient, appointment, clinicId, doctorEmail }) {\r\n  const [consultations, setConsultations] = useState([]);\r\n  const [selectedConsult, setSelectedConsult] = useState(null);\r\n  const [error, setError] = useState(null);\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      if (!patient || !clinicId) {\r\n        setConsultations([]);\r\n        return;\r\n      }\r\n      try {\r\n        // patient.id is expected to be the NIC (per your design)\r\n        const list = await fetchConsultationsForPatient(clinicId, patient.id);\r\n        setConsultations(list);\r\n      } catch (err) {\r\n        console.error(err);\r\n        setError(err.message || String(err));\r\n      }\r\n    })();\r\n  }, [patient, clinicId]);\r\n\r\n  function formatDateShort(iso) {\r\n    if (!iso) return '-';\r\n    try {\r\n      const d = new Date(iso);\r\n      // e.g., 22 Nov 1980\r\n      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });\r\n    } catch {\r\n      return iso;\r\n    }\r\n  }\r\n\r\n  const firstName = patient?.firstName ?? patient?.givenName ?? '';\r\n  const lastName = patient?.lastName ?? patient?.familyName ?? '';\r\n\r\n  // allergies may be stored as array or string\r\n  function renderAllergies(allergyField) {\r\n    if (!allergyField) return '-';\r\n    if (Array.isArray(allergyField)) {\r\n      return allergyField.length ? allergyField.join(', ') : '-';\r\n    }\r\n    const s = String(allergyField).trim();\r\n    return s.length ? s : '-';\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"rounded-xl bg-white p-6 shadow-sm\">\r\n        <div className=\"flex items-start justify-between\">\r\n          <div>\r\n            <h2 className=\"text-xl font-semibold\">\r\n              {patient ? `${firstName} ${lastName}`.trim() : 'No patient selected'}\r\n            </h2>\r\n            <div className=\"text-sm text-slate-500 mt-1\">\r\n              NIC: {patient?.id ?? '-'}\r\n            </div>\r\n            <div className=\"mt-3 text-sm text-slate-600 space-y-1\">\r\n              <div><strong>DOB:</strong> {patient?.dob ? formatDateShort(patient.dob) : '-'}</div>\r\n              <div><strong>Gender:</strong> {patient?.gender ?? patient?.sex ?? '-'}</div>\r\n              <div><strong>Allergies:</strong> {renderAllergies(patient?.allergies)}</div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-4 text-sm text-slate-600\">\r\n          {patient ? (\r\n            <>\r\n              <div className=\"font-medium text-sm mb-1\">Contact Details:</div>\r\n              <div><strong>Phone:</strong> {patient.phone ?? '-'}</div>\r\n              <div><strong>Address:</strong> {patient.address ?? '-'}</div>\r\n            </>\r\n          ) : <div>Select a patient or appointment to begin.</div>}\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"rounded-xl bg-white p-4 shadow-sm\">\r\n        <h3 className=\"text-sm font-medium text-slate-800\">Appointment details</h3>\r\n        <div className=\"text-sm text-slate-600 mt-2\">\r\n          {appointment ? (\r\n            <>\r\n              <div><strong>Time:</strong> {new Date(appointment.scheduledAt).toLocaleString()}</div>\r\n              <div><strong>Status:</strong> {appointment.status}</div>\r\n              <div><strong>Notes:</strong> {appointment.notes || '-'}</div>\r\n            </>\r\n          ) : <div className=\"text-sm text-slate-400\">No appointment selected.</div>}\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"rounded-xl bg-white p-4 shadow-sm\">\r\n        <h3 className=\"text-sm font-medium text-slate-800\">Consultation</h3>\r\n        <div className=\"mt-3\">\r\n          <NewConsultationForm\r\n            patient={patient}\r\n            appointmentId={appointment?.id}\r\n            clinicId={clinicId}\r\n            doctorEmail={doctorEmail}\r\n            onSaved={(created) => {\r\n              (async () => {\r\n                try {\r\n                  const list = await fetchConsultationsForPatient(clinicId, patient.id);\r\n                  setConsultations(list);\r\n                } catch (err) {\r\n                  console.error(err);\r\n                }\r\n              })();\r\n            }}\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"rounded-xl bg-white p-4 shadow-sm\">\r\n        <h3 className=\"text-sm font-medium text-slate-800\">Previous Consultations</h3>\r\n        <div className=\"mt-3 space-y-2\">\r\n          {consultations.length === 0 && <div className=\"text-sm text-slate-400\">No consultations yet</div>}\r\n          {consultations.map(c => (\r\n            <div key={c.id} className=\"p-3 border rounded\">\r\n              <div className=\"flex justify-between\">\r\n                <div className=\"font-medium text-sm\">{new Date(c.createdAt).toLocaleString()}</div>\r\n                <div className=\"text-xs text-slate-500\">{c.id}</div>\r\n              </div>\r\n              <div className=\"text-sm text-slate-600 mt-2\"><strong>Complaint:</strong> {c.presentComplaint || '-'}</div>\r\n              <div className=\"text-sm text-slate-600 mt-1\"><strong>Management:</strong> {c.management || '-'}</div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1863, "column": 0}, "map": {"version":3,"sources":["file:///D:/Education/WebDev%20with%20AI/Projects/clinic-suite/app/consultation/page.js"],"sourcesContent":["// app/consultation/page.js\r\n'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport { useAuth } from '../../components/AuthProvider';\r\nimport ConsultationSidebar from '../../components/ConsultationSidebar';\r\nimport ConsultationDetailCard from '../../components/ConsultationDetailCard';\r\nimport {\r\n  subscribeAppointmentsByDate,\r\n  getPatient\r\n} from '../../lib/firestoreClient';\r\n\r\nexport default function ConsultationPage() {\r\n  const { user, claims, loading } = useAuth();\r\n  const [date, setDate] = useState(() => new Date().toISOString().slice(0, 10));\r\n  const [appointments, setAppointments] = useState([]);\r\n  const [selectedAppointment, setSelectedAppointment] = useState(null);\r\n  const [selectedPatient, setSelectedPatient] = useState(null);\r\n  const [error, setError] = useState(null);\r\n\r\n  // Client-side authorization: only allow role === 'doctor' in clinic to see this page\r\n  const isAuthReady = !loading;\r\n  const isDoctor = Boolean(claims?.role === 'doctor' && claims?.clinicId);\r\n\r\n  useEffect(() => {\r\n    // if user is not a doctor, do not subscribe to any data\r\n    if (!isAuthReady || !isDoctor) return;\r\n    setError(null);\r\n    const unsub = subscribeAppointmentsByDate(\r\n      claims.clinicId,\r\n      new Date(date),\r\n      (items) => {\r\n        setAppointments(items);\r\n      },\r\n      (err) => setError(err.message || String(err))\r\n    );\r\n    return () => {\r\n      if (typeof unsub === 'function') unsub();\r\n    };\r\n  }, [isAuthReady, isDoctor, claims?.clinicId, date]);\r\n\r\n  // when user selects an appointment, load the patient\r\n  async function handleSelectAppointment(appt) {\r\n    setError(null);\r\n    setSelectedAppointment(appt || null);\r\n    if (!appt || !appt.patientNic) {\r\n      setSelectedPatient(null);\r\n      return;\r\n    }\r\n    try {\r\n      // fetch patient (returns null if not found)\r\n      const p = await getPatient(claims.clinicId, appt.patientNic);\r\n      if (!p) {\r\n        setError(`Patient ${appt.patientNic} not found`);\r\n        setSelectedPatient(null);\r\n        return;\r\n      }\r\n      setSelectedPatient(p);\r\n    } catch (err) {\r\n      console.error('Failed to load patient', err);\r\n      setError(err.message || String(err));\r\n      setSelectedPatient(null);\r\n    }\r\n  }\r\n\r\n  // Simple helpers for display states\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-[calc(100vh-56px)] flex items-center justify-center\">\r\n        <div className=\"text-sm text-slate-500\">Loading authentication...</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) {\r\n    return (\r\n      <div className=\"min-h-[calc(100vh-56px)] flex items-center justify-center\">\r\n        <div className=\"max-w-lg p-6 bg-white rounded-lg shadow\">\r\n          <h2 className=\"text-lg font-semibold\">Sign in required</h2>\r\n          <p className=\"mt-2 text-sm text-slate-600\">You must be signed in to access the Consultation area.</p>\r\n          <div className=\"mt-4 text-right\">\r\n            <a href=\"/login\" className=\"px-3 py-2 bg-indigo-600 text-white rounded\">Go to login</a>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // User is signed in but not a doctor (or missing clinicId)\r\n  if (!isDoctor) {\r\n    return (\r\n      <div className=\"min-h-[calc(100vh-56px)] flex items-center justify-center bg-slate-50\">\r\n        <div className=\"max-w-xl w-full p-6 bg-white rounded-lg shadow\">\r\n          <h2 className=\"text-xl font-semibold text-slate-800\">Access denied</h2>\r\n          <p className=\"mt-2 text-sm text-slate-600\">Your account does not have permission to access the Consultation area.</p>\r\n\r\n          <div className=\"mt-4 text-sm text-slate-600\">\r\n            <p><strong>Role:</strong> {claims?.role ?? '—'}</p>\r\n            <p><strong>Clinic:</strong> {claims?.clinicId ?? '—'}</p>\r\n          </div>\r\n\r\n          <div className=\"mt-4 flex gap-2\">\r\n            <button onClick={() => window.location.href = '/'} className=\"px-3 py-2 rounded border\">Back to home</button>\r\n          </div>\r\n\r\n          <div className=\"mt-3 text-xs text-slate-400\">\r\n            Note: Consultations are restricted to users with role <code>doctor</code>. Contact your administrator to get access.\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Authorized doctor: render the consultation UI\r\n  return (\r\n    <div className=\"min-h-[calc(100vh-56px)] bg-slate-50\">\r\n      <div className=\"max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-6\">\r\n        <aside className=\"lg:col-span-3\">\r\n          <ConsultationSidebar\r\n            clinicId={claims.clinicId}\r\n            appointments={appointments}\r\n            selectedAppointmentId={selectedAppointment?.id}\r\n            onSelect={handleSelectAppointment}\r\n          />\r\n        </aside>\r\n\r\n        <main className=\"lg:col-span-6\">\r\n          <ConsultationDetailCard\r\n            patient={selectedPatient}\r\n            appointment={selectedAppointment}\r\n            clinicId={claims?.clinicId}\r\n            doctorEmail={user?.email}\r\n          />\r\n        </main>\r\n\r\n        <aside className=\"lg:col-span-3\">\r\n          <div className=\"sticky top-6\">\r\n            <div className=\"rounded-xl bg-white shadow-sm p-4\">\r\n              <h3 className=\"text-sm text-slate-500\">Quick actions</h3>\r\n              <div className=\"mt-3 flex flex-col gap-2\">\r\n                <button onClick={() => { setSelectedAppointment(null); setSelectedPatient(null); }} className=\"text-sm px-3 py-2 rounded-md border border-slate-100 text-slate-700\">Clear selection</button>\r\n                <button onClick={() => window.location.reload()} className=\"text-sm px-3 py-2 rounded-md border border-slate-100 text-slate-700\">Refresh</button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </aside>\r\n      </div>\r\n\r\n      {error && (\r\n        <div className=\"max-w-7xl mx-auto px-4 py-2\">\r\n          <div className=\"rounded-md bg-red-50 border border-red-200 p-3 text-sm text-red-700\">{error}</div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}